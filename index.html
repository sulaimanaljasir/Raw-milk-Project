<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Milk Project - Qassim University</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --qu-primary: #2563EB;
            --qu-secondary: #60A5FA;
            --qu-dark: #1E40AF;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f7f9fc;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, var(--qu-primary), var(--qu-dark));
            color: white;
            padding: 20px;
            text-align: center;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 20px; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
        }
        button {
            background: var(--qu-primary);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        button:hover { background: var(--qu-dark); }
        .btn-success { background: #38a169; }
        .btn-success:hover { background: #2f855a; }
        .btn-secondary { background: var(--qu-secondary); }
        .btn-danger { background: #e53e3e; }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }
        .photo-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }
        input[type="file"] { display: none; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
        }
        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .sample-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .tab {
            background: transparent;
            color: #718096;
            padding: 12px 24px;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
        }
        .tab.active {
            color: var(--qu-primary);
            border-bottom-color: var(--qu-primary);
        }
        .view { display: none; }
        .view.active { display: block; }
        .alert {
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
        }
        .alert-error {
            background: #fed7d7;
            color: #742a2a;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Raw Milk Project</h1>
        <p>One Health Laboratory - Qassim University</p>
    </div>

    <!-- Login -->
    <div id="loginView">
        <div class="container">
            <div class="card" style="max-width: 450px; margin: 40px auto;">
                <h2 style="color: var(--qu-primary); margin-bottom: 25px;">Login</h2>
                <div id="loginAlert"></div>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" style="width: 100%;">Login</button>
                </form>
            </div>
        </div>
    </div>

    <!-- App -->
    <div id="appView" style="display: none;">
        <div class="container">
            <div style="background: var(--qu-primary); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between;">
                <span id="userName"></span>
                <button onclick="handleLogout()" class="btn-danger">Logout</button>
            </div>

            <div class="card">
                <div class="tab-container">
                    <button class="tab active" onclick="switchTab('collect')">üìù Collect</button>
                    <button class="tab" onclick="switchTab('samples')">üìä Samples</button>
                    <button class="tab" id="settingsTab" onclick="switchTab('settings')" style="display:none;">‚öôÔ∏è Settings</button>
                </div>

                <!-- Collect View -->
                <div id="collectView" class="view active">
                    <h2 style="color: var(--qu-primary);">New Sample</h2>
                    <form id="sampleForm">
                        <div class="form-group">
                            <label>Sample ID</label>
                            <input type="text" id="sampleId" readonly style="background: #f7f9fc; font-weight: bold;">
                        </div>

                        <div class="form-group">
                            <label>Animal Type *</label>
                            <select id="animalType" required>
                                <option value="">Select</option>
                                <option value="Camel">Camel</option>
                                <option value="Sheep">Sheep</option>
                                <option value="Goat">Goat</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Source Type *</label>
                            <select id="sourceType" required>
                                <option value="">Select</option>
                                <option value="Farm">Farm</option>
                                <option value="Free-ranging">Free-ranging</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Health Status *</label>
                            <select id="healthStatus" required>
                                <option value="">Select</option>
                                <option value="Healthy">Healthy</option>
                                <option value="Diseased">Diseased</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="notes" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Photos (1-5 photos) *</label>
                            <input type="file" id="photoInput" accept="image/*" capture="environment" multiple>
                            <button type="button" onclick="document.getElementById('photoInput').click()">üì∏ Take Photos</button>
                            <div id="photoPreview" class="photo-grid"></div>
                        </div>

                        <div class="form-group">
                            <label>GPS Location *</label>
                            <button type="button" id="gpsBtn" onclick="captureGPS()">üìç Capture GPS</button>
                            <div id="gpsInfo" style="display:none; margin-top:10px; padding:10px; background:#c6f6d5; border-radius:8px;"></div>
                        </div>

                        <div class="form-group">
                            <label>Date & Time</label>
                            <input type="text" id="datetime" readonly style="background: #f7f9fc;">
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button type="button" onclick="saveDraft()" class="btn-secondary" style="flex:1;">üíæ Save Draft</button>
                            <button type="button" onclick="showSubmitModal()" class="btn-success" style="flex:2;">‚úÖ Submit</button>
                        </div>
                    </form>
                </div>

                <!-- Samples View -->
                <div id="samplesView" class="view">
                    <h2 style="color: var(--qu-primary);">Samples</h2>
                    <div id="samplesContainer" class="sample-grid"></div>
                </div>

                <!-- Settings -->
                <div id="settingsView" class="view">
                    <h2 style="color: var(--qu-primary);">Settings</h2>
                    <h3 style="margin-top: 20px;">Add Student</h3>
                    <div style="display: grid; gap: 10px; margin-top: 10px;">
                        <input type="text" id="newName" placeholder="Name">
                        <input type="text" id="newUsername" placeholder="Username">
                        <input type="password" id="newPassword" placeholder="Password">
                        <select id="newTeam">
                            <option value="">Select Team</option>
                            <option value="Team A">Team A</option>
                            <option value="Team B">Team B</option>
                            <option value="Team C">Team C</option>
                            <option value="Team D">Team D</option>
                        </select>
                        <button onclick="addStudent()">Add Student</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Modal -->
    <div id="submitModal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--qu-primary);">‚ö†Ô∏è Confirm Submission</h3>
            <p style="margin: 15px 0;">Are you sure you want to submit this sample?</p>
            <p style="color: #718096; font-size: 14px;">Once submitted, you cannot edit or delete.</p>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                <button onclick="closeSubmitModal()" class="btn-secondary">Cancel</button>
                <button onclick="confirmSubmit()" class="btn-success">Yes, Submit</button>
            </div>
        </div>
    </div>

    <script>
        // STATE
        let currentUser = null;
        let samples = [];
        let users = [];
        let photos = [];
        let gpsData = null;
        let sampleCounter = 0;

        // INITIALIZE
        function init() {
            // Default users
            users = JSON.parse(localStorage.getItem('users')) || [
                { id: 1, name: 'Dr. Sulaiman Aljasir', username: 'sulaiman', password: '220150', role: 'admin', team: null },
                { id: 2, name: 'Ibrahim', username: 'ibrahim', password: '330160', role: 'admin', team: null },
                { id: 3, name: 'Imran', username: 'imran', password: '440170', role: 'admin', team: null }
            ];

            // Load data
            samples = JSON.parse(localStorage.getItem('samples')) || [];
            sampleCounter = parseInt(localStorage.getItem('sampleCounter')) || 0;

            // Setup
            generateSampleId();
            updateDateTime();
            document.getElementById('photoInput').addEventListener('change', handlePhotos);

            // Auto-login check
            const saved = localStorage.getItem('currentUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                showApp();
            }
        }

        // LOGIN
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value.trim();

            console.log('Login attempt:', username, password);
            console.log('Users:', users);

            const user = users.find(u => u.username.toLowerCase() === username && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                document.getElementById('loginView').style.display = 'none';
                document.getElementById('appView').style.display = 'block';
                showApp();
            } else {
                document.getElementById('loginAlert').innerHTML = '<div class="alert alert-error">‚ùå Invalid username or password</div>';
            }
        }

        function handleLogout() {
            localStorage.removeItem('currentUser');
            location.reload();
        }

        function showApp() {
            document.getElementById('userName').textContent = currentUser.name;
            if (currentUser.role === 'admin') {
                document.getElementById('settingsTab').style.display = 'block';
            }
            renderSamples();
        }

        // SAMPLE ID
        function generateSampleId() {
            let max = 0;
            samples.forEach(s => {
                const match = s.sampleId.match(/RM-(\d+)/);
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > max) max = num;
                }
            });
            sampleCounter = max + 1;
            document.getElementById('sampleId').value = 'RM-' + sampleCounter;
            localStorage.setItem('sampleCounter', sampleCounter);
        }

        function updateDateTime() {
            document.getElementById('datetime').value = new Date().toLocaleString();
        }

        // PHOTOS
        function handlePhotos(e) {
            const files = Array.from(e.target.files).slice(0, 5); // Max 5
            photos = [];
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            files.forEach((file) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    photos.push(event.target.result);
                    const div = document.createElement('div');
                    div.className = 'photo-item';
                    div.innerHTML = '<img src="' + event.target.result + '">';
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // GPS
        function captureGPS() {
            const btn = document.getElementById('gpsBtn');
            btn.disabled = true;
            btn.textContent = 'üìç Getting GPS...';

            if (!navigator.geolocation) {
                alert('GPS not supported');
                btn.disabled = false;
                btn.textContent = 'üìç Capture GPS';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const acc = pos.coords.accuracy;
                    if (acc > 100) {
                        if (confirm('Weak GPS (' + Math.round(acc) + 'm). Save without GPS?')) {
                            gpsData = { lat: null, lng: null, pending: true };
                        } else {
                            btn.disabled = false;
                            btn.textContent = 'üìç Capture GPS';
                            return;
                        }
                    } else {
                        gpsData = {
                            lat: pos.coords.latitude,
                            lng: pos.coords.longitude,
                            acc: acc,
                            pending: false
                        };
                    }

                    document.getElementById('gpsInfo').style.display = 'block';
                    document.getElementById('gpsInfo').textContent = gpsData.pending ?
                        '‚ö†Ô∏è GPS Pending' :
                        '‚úì GPS: ' + gpsData.lat.toFixed(4) + ', ' + gpsData.lng.toFixed(4);

                    btn.disabled = false;
                    btn.textContent = '‚úì GPS Captured';
                },
                (err) => {
                    if (confirm('GPS Error. Save without GPS?')) {
                        gpsData = { lat: null, lng: null, pending: true };
                        document.getElementById('gpsInfo').style.display = 'block';
                        document.getElementById('gpsInfo').textContent = '‚ö†Ô∏è No GPS';
                        btn.textContent = '‚ö†Ô∏è No GPS';
                    }
                    btn.disabled = false;
                },
                { enableHighAccuracy: true, timeout: 15000 }
            );
        }

        // SAVE DRAFT
        function saveDraft() {
            const animal = document.getElementById('animalType').value;
            const source = document.getElementById('sourceType').value;

            if (!animal || !source) {
                alert('Please fill Animal Type and Source Type');
                return;
            }

            const draft = {
                id: Date.now(),
                sampleId: document.getElementById('sampleId').value,
                animalType: animal,
                sourceType: source,
                healthStatus: document.getElementById('healthStatus').value,
                notes: document.getElementById('notes').value,
                photos: photos,
                gps: gpsData,
                collectedBy: currentUser.name,
                team: currentUser.team,
                timestamp: new Date().toISOString(),
                status: 'draft'
            };

            samples.push(draft);
            localStorage.setItem('samples', JSON.stringify(samples));
            alert('‚úÖ Draft saved!');
        }

        // SUBMIT
        function showSubmitModal() {
            const animal = document.getElementById('animalType').value;
            const source = document.getElementById('sourceType').value;
            const health = document.getElementById('healthStatus').value;

            if (!animal || !source || !health) {
                alert('‚ùå Please fill all required fields');
                return;
            }

            if (!gpsData) {
                alert('‚ùå Please capture GPS (or accept weak signal)');
                return;
            }

            if (photos.length === 0) {
                alert('‚ùå Please take at least 1 photo');
                return;
            }

            document.getElementById('submitModal').classList.add('show');
        }

        function closeSubmitModal() {
            document.getElementById('submitModal').classList.remove('show');
        }

        function confirmSubmit() {
            const sample = {
                id: Date.now(),
                sampleId: document.getElementById('sampleId').value,
                animalType: document.getElementById('animalType').value,
                sourceType: document.getElementById('sourceType').value,
                healthStatus: document.getElementById('healthStatus').value,
                notes: document.getElementById('notes').value,
                photos: photos,
                gps: gpsData,
                collectedBy: currentUser.name,
                team: currentUser.team,
                timestamp: new Date().toISOString(),
                status: 'submitted'
            };

            samples.push(sample);
            localStorage.setItem('samples', JSON.stringify(samples));

            // Increment counter
            sampleCounter++;
            localStorage.setItem('sampleCounter', sampleCounter);

            closeSubmitModal();
            alert('‚úÖ Sample submitted!');

            // Reset form
            document.getElementById('sampleForm').reset();
            photos = [];
            gpsData = null;
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('gpsInfo').style.display = 'none';
            document.getElementById('gpsBtn').textContent = 'üìç Capture GPS';
            generateSampleId();
            updateDateTime();
        }

        // RENDER SAMPLES
        function renderSamples() {
            const container = document.getElementById('samplesContainer');

            if (samples.length === 0) {
                container.innerHTML = '<p style="color: #718096;">No samples yet</p>';
                return;
            }

            let filtered = [...samples];
            if (currentUser.role !== 'admin') {
                filtered = filtered.filter(s => s.team === currentUser.team);
            }

            // Sort newest first
            filtered.sort((a, b) => {
                const aNum = parseInt(a.sampleId.replace('RM-', ''));
                const bNum = parseInt(b.sampleId.replace('RM-', ''));
                return bNum - aNum;
            });

            container.innerHTML = filtered.map(s => `
                <div class="sample-card">
                    <h3 style="color: var(--qu-primary);">${s.sampleId}</h3>
                    <p><strong>Animal:</strong> ${s.animalType}</p>
                    <p><strong>Source:</strong> ${s.sourceType}</p>
                    <p><strong>Health:</strong> ${s.healthStatus}</p>
                    <p><strong>Status:</strong> ${s.status === 'submitted' ? '‚úÖ Submitted' : '‚ö†Ô∏è Draft'}</p>
                    <p><strong>By:</strong> ${s.collectedBy}</p>
                    <p><strong>Team:</strong> ${s.team || 'N/A'}</p>
                    <p><strong>Photos:</strong> ${s.photos ? s.photos.length : 0}</p>
                    ${s.gps && s.gps.lat ? '<p><strong>GPS:</strong> ' + s.gps.lat.toFixed(4) + ', ' + s.gps.lng.toFixed(4) + '</p>' : ''}
                    ${s.gps && s.gps.pending ? '<p style="color: #dd6b20;">‚ö†Ô∏è GPS Pending</p>' : ''}
                </div>
            `).join('');
        }

        // TABS
        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(name + 'View').classList.add('active');

            if (name === 'samples') renderSamples();
        }

        // ADD STUDENT
        function addStudent() {
            const name = document.getElementById('newName').value.trim();
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const team = document.getElementById('newTeam').value;

            if (!name || !username || !password || !team) {
                alert('Fill all fields');
                return;
            }

            if (users.find(u => u.username.toLowerCase() === username.toLowerCase())) {
                alert('Username exists');
                return;
            }

            users.push({
                id: Date.now(),
                name: name,
                username: username.toLowerCase(),
                password: password,
                role: 'student',
                team: team
            });

            localStorage.setItem('users', JSON.stringify(users));
            alert('‚úÖ Student added: ' + name);

            document.getElementById('newName').value = '';
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newTeam').value = '';
        }

        // START
        window.addEventListener('load', init);
    </script>
</body>
</html>
