<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Milk Project - Qassim University</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f7f9fc;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #2563EB, #1E40AF);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
        }
        button {
            background: #2563EB;
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        button:hover { background: #1E40AF; }
        button:disabled { background: #cbd5e0; cursor: not-allowed; }
        .btn-success { background: #38a169; }
        .btn-success:hover { background: #2f855a; }
        .btn-secondary { background: #60A5FA; }
        .btn-danger { background: #e53e3e; }
        .btn-warning { background: #dd6b20; }
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            margin-right: 5px;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .photo-item {
            position: relative;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        .photo-item img { width: 100%; height: 100px; object-fit: cover; display: block; }
        .photo-item button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            padding: 0;
            font-size: 16px;
            line-height: 1;
        }
        input[type="file"] { display: none; }
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
        }
        .modal.active {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .sample-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .sample-card.draft {
            border-left: 4px solid #dd6b20;
            background: #fffaf0;
        }
        .sample-card.submitted {
            border-left: 4px solid #38a169;
        }
        .tab-container { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .tab {
            background: transparent;
            color: #718096;
            padding: 12px 24px;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
        }
        .tab.active { color: #2563EB; border-bottom-color: #2563EB; }
        .view { display: none; }
        .view.active { display: block; }
        .alert { padding: 14px; border-radius: 10px; margin-bottom: 20px; }
        .alert-error { background: #fed7d7; color: #742a2a; }
        .alert-warning { background: #feebc8; color: #744210; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Raw Milk Project</h1>
        <p>One Health Laboratory - Qassim University</p>
    </div>

    <!-- Login -->
    <div id="loginView">
        <div class="container">
            <div class="card" style="max-width: 450px; margin: 40px auto;">
                <h2 style="color: #2563EB; margin-bottom: 25px;">Login</h2>
                <div id="loginAlert"></div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword">
                </div>
                <button onclick="doLogin()" style="width: 100%;">Login</button>
            </div>
        </div>
    </div>

    <!-- App -->
    <div id="appView" style="display: none;">
        <div class="container">
            <div style="background: #2563EB; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <span id="userName"></span>
                <button onclick="doLogout()" class="btn-danger">Logout</button>
            </div>

            <div class="card">
                <div class="tab-container">
                    <button class="tab active" onclick="goToTab('collect')">üìù Collect</button>
                    <button class="tab" onclick="goToTab('samples')">üìä Samples</button>
                    <button class="tab" id="settingsTab" onclick="goToTab('settings')" style="display:none;">‚öôÔ∏è Settings</button>
                </div>

                <!-- Collect -->
                <div id="collectView" class="view active">
                    <h2 style="color: #2563EB;">New Sample</h2>
                    <div id="draftWarning"></div>

                    <div class="form-group">
                        <label>Sample ID (Reserved)</label>
                        <input type="text" id="sampleId" readonly style="background: #f7f9fc; font-weight: bold; color: #2563EB;">
                        <p style="font-size: 12px; color: #718096; margin-top: 5px;">This ID is reserved for this sample only</p>
                    </div>

                    <div class="form-group">
                        <label>Animal Type *</label>
                        <select id="animalType" onchange="checkForDuplicateDraft()">
                            <option value="">Select</option>
                            <option value="Camel">Camel</option>
                            <option value="Sheep">Sheep</option>
                            <option value="Goat">Goat</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Source Type *</label>
                        <select id="sourceType" onchange="checkForDuplicateDraft()">
                            <option value="">Select</option>
                            <option value="Farm">Farm</option>
                            <option value="Free-ranging">Free-ranging</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Health Status *</label>
                        <select id="healthStatus">
                            <option value="">Select</option>
                            <option value="Healthy">Healthy</option>
                            <option value="Diseased">Diseased</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="notes" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Photos (1-5) *</label>
                        <input type="file" id="photoInput" accept="image/*" capture="environment" multiple>
                        <button onclick="openCameraClick()">üì∏ Take Photos</button>
                        <div id="photoPreview" class="photo-grid"></div>
                        <p id="photoCount" style="margin-top: 8px; font-size: 13px; color: #2563EB;"></p>
                    </div>

                    <div class="form-group">
                        <label>GPS Location *</label>
                        <button id="gpsBtn" onclick="captureGPSClick()">üìç Capture GPS</button>
                        <div id="gpsInfo" style="display:none; margin-top:10px; padding:10px; background:#c6f6d5; border-radius:8px;"></div>
                    </div>

                    <div class="form-group">
                        <label>Date & Time</label>
                        <input type="text" id="datetime" readonly style="background: #f7f9fc;">
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="clickSaveDraft()" class="btn-secondary" style="flex:1;">üíæ Save Draft</button>
                        <button onclick="clickSubmit()" class="btn-success" style="flex:2; font-size: 18px;">‚úÖ Submit Sample</button>
                    </div>
                </div>

                <!-- Samples -->
                <div id="samplesView" class="view">
                    <h2 style="color: #2563EB;">Sample Records</h2>
                    <div style="margin: 15px 0;">
                        <label style="display: inline; margin-right: 10px;">
                            <input type="checkbox" id="showDrafts" onchange="showSamples()" checked> Show Drafts
                        </label>
                        <label style="display: inline;">
                            <input type="checkbox" id="showSubmitted" onchange="showSamples()" checked> Show Submitted
                        </label>
                    </div>
                    <div id="samplesContainer" class="sample-grid"></div>
                </div>

                <!-- Settings -->
                <div id="settingsView" class="view">
                    <h2 style="color: #2563EB;">Settings</h2>
                    <h3 style="margin-top: 20px;">Add Student</h3>
                    <input type="text" id="newName" placeholder="Name" style="margin-bottom: 10px;">
                    <input type="text" id="newUsername" placeholder="Username" style="margin-bottom: 10px;">
                    <input type="password" id="newPassword" placeholder="Password" style="margin-bottom: 10px;">
                    <select id="newTeam" style="margin-bottom: 10px;">
                        <option value="">Select Team</option>
                        <option value="Team A">Team A</option>
                        <option value="Team B">Team B</option>
                        <option value="Team C">Team C</option>
                        <option value="Team D">Team D</option>
                    </select>
                    <button onclick="clickAddStudent()">Add Student</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Modal -->
    <div id="submitModal" class="modal">
        <div class="modal-content">
            <h3 style="color: #2563EB; margin-bottom: 15px;">‚ö†Ô∏è Confirm Submission</h3>
            <p style="margin: 15px 0;">Are you sure you want to submit this sample?</p>
            <p style="color: #718096; font-size: 14px; margin-bottom: 20px;"><strong>Once submitted, you cannot edit or delete.</strong></p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="clickCancel()" class="btn-secondary">Cancel</button>
                <button onclick="clickConfirmSubmit()" class="btn-success">Yes, Submit</button>
            </div>
        </div>
    </div>

    <script>
        // STATE
        var currentUser = null;
        var samples = [];
        var users = [];
        var photos = [];
        var gpsData = null;
        var reservedSampleId = null;
        var editingDraftId = null; // Track if editing a draft

        // INIT
        function init() {
            var stored = localStorage.getItem('users');
            if (stored) {
                users = JSON.parse(stored);
            } else {
                users = [
                    { id: 1, name: 'Dr. Sulaiman Aljasir', username: 'sulaiman', password: '220150', role: 'admin', team: null },
                    { id: 2, name: 'Ibrahim', username: 'ibrahim', password: '330160', role: 'admin', team: null },
                    { id: 3, name: 'Imran', username: 'imran', password: '440170', role: 'admin', team: null }
                ];
                localStorage.setItem('users', JSON.stringify(users));
            }

            var storedSamples = localStorage.getItem('samples');
            samples = storedSamples ? JSON.parse(storedSamples) : [];

            document.getElementById('photoInput').addEventListener('change', handlePhotoChange);

            updateTime();
            setInterval(updateTime, 60000);

            var savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('loginView').style.display = 'none';
                document.getElementById('appView').style.display = 'block';
                showAppContent();
            }
        }

        function doLogin() {
            var username = document.getElementById('loginUsername').value.trim().toLowerCase();
            var password = document.getElementById('loginPassword').value.trim();

            var user = users.find(function(u) {
                return u.username.toLowerCase() === username && u.password === password;
            });

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                document.getElementById('loginView').style.display = 'none';
                document.getElementById('appView').style.display = 'block';
                showAppContent();
            } else {
                document.getElementById('loginAlert').innerHTML = '<div class="alert alert-error">‚ùå Invalid username or password</div>';
            }
        }

        function doLogout() {
            localStorage.removeItem('currentUser');
            location.reload();
        }

        function showAppContent() {
            document.getElementById('userName').textContent = currentUser.name;
            if (currentUser.role === 'admin') {
                document.getElementById('settingsTab').style.display = 'block';
            }
            reserveNewSampleId();
            showSamples();
        }

        function reserveNewSampleId() {
            var maxNum = 0;
            samples.forEach(function(s) {
                var match = s.sampleId.match(/RM-(\d+)/);
                if (match) {
                    var num = parseInt(match[1]);
                    if (num > maxNum) maxNum = num;
                }
            });

            reservedSampleId = 'RM-' + (maxNum + 1);
            document.getElementById('sampleId').value = reservedSampleId;
        }

        function updateTime() {
            document.getElementById('datetime').value = new Date().toLocaleString();
        }

        // PHOTOS
        function openCameraClick() {
            document.getElementById('photoInput').click();
        }

        function handlePhotoChange(e) {
            var files = Array.from(e.target.files);
            var remaining = 5 - photos.length;
            var toAdd = files.slice(0, remaining);

            toAdd.forEach(function(file) {
                var reader = new FileReader();
                reader.onload = function(event) {
                    photos.push(event.target.result);
                    showPhotos();
                };
                reader.readAsDataURL(file);
            });

            e.target.value = '';
        }

        function showPhotos() {
            var preview = document.getElementById('photoPreview');
            var count = document.getElementById('photoCount');

            preview.innerHTML = '';
            photos.forEach(function(photoData, i) {
                var div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = '<img src="' + photoData + '"><button onclick="removePhotoAt(' + i + ')">√ó</button>';
                preview.appendChild(div);
            });

            count.textContent = photos.length + ' / 5 photos';
        }

        function removePhotoAt(index) {
            photos.splice(index, 1);
            showPhotos();
        }

        // GPS
        function captureGPSClick() {
            var btn = document.getElementById('gpsBtn');
            var info = document.getElementById('gpsInfo');

            btn.disabled = true;
            btn.textContent = 'üìç Getting GPS...';

            if (!navigator.geolocation) {
                alert('GPS not supported');
                btn.disabled = false;
                btn.textContent = 'üìç Capture GPS';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    var acc = pos.coords.accuracy;
                    if (acc > 100) {
                        if (confirm('Weak GPS (' + Math.round(acc) + 'm). Save without GPS?')) {
                            gpsData = { lat: null, lng: null, pending: true };
                            info.style.display = 'block';
                            info.style.background = '#feebc8';
                            info.style.color = '#744210';
                            info.textContent = '‚ö†Ô∏è GPS Pending';
                            btn.textContent = '‚ö†Ô∏è GPS Pending';
                        } else {
                            btn.textContent = 'üìç Capture GPS';
                        }
                    } else {
                        gpsData = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: acc, pending: false };
                        info.style.display = 'block';
                        info.style.background = '#c6f6d5';
                        info.style.color = '#22543d';
                        info.textContent = '‚úì GPS: ' + gpsData.lat.toFixed(4) + ', ' + gpsData.lng.toFixed(4);
                        btn.textContent = '‚úì GPS Captured';
                    }
                    btn.disabled = false;
                },
                function(err) {
                    if (confirm('GPS Error. Save without GPS?')) {
                        gpsData = { lat: null, lng: null, pending: true };
                        info.style.display = 'block';
                        info.style.background = '#feebc8';
                        info.textContent = '‚ö†Ô∏è No GPS';
                        btn.textContent = '‚ö†Ô∏è No GPS';
                    } else {
                        btn.textContent = 'üìç Capture GPS';
                    }
                    btn.disabled = false;
                },
                { enableHighAccuracy: true, timeout: 15000 }
            );
        }

        // CHECK FOR DUPLICATE DRAFTS
        function checkForDuplicateDraft() {
            var animal = document.getElementById('animalType').value;
            var source = document.getElementById('sourceType').value;

            if (!animal || !source) return;

            var existingDraft = samples.find(function(s) {
                return s.status === 'draft' && s.animalType === animal && s.sourceType === source && s.id !== editingDraftId;
            });

            if (existingDraft) {
                var warning = document.getElementById('draftWarning');
                warning.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è You have a similar draft (' + existingDraft.sampleId + '). <button onclick="loadDraft(' + existingDraft.id + ')" class="btn-small btn-warning">Load Draft</button></div>';
            } else {
                document.getElementById('draftWarning').innerHTML = '';
            }
        }

        // SAVE DRAFT
        function clickSaveDraft() {
            var animal = document.getElementById('animalType').value;
            var source = document.getElementById('sourceType').value;

            if (!animal || !source) {
                alert('‚ùå Fill at least Animal Type and Source Type');
                return;
            }

            var draft = {
                id: editingDraftId || Date.now(),
                sampleId: reservedSampleId,
                animalType: animal,
                sourceType: source,
                healthStatus: document.getElementById('healthStatus').value,
                notes: document.getElementById('notes').value,
                photos: photos.slice(),
                gps: gpsData,
                collectedBy: currentUser.name,
                team: currentUser.team || null,
                timestamp: new Date().toISOString(),
                datetime: document.getElementById('datetime').value,
                status: 'draft'
            };

            if (editingDraftId) {
                // Update existing draft
                var index = samples.findIndex(function(s) { return s.id === editingDraftId; });
                if (index >= 0) samples[index] = draft;
            } else {
                // New draft
                samples.push(draft);
            }

            localStorage.setItem('samples', JSON.stringify(samples));
            alert('‚úÖ Draft saved: ' + reservedSampleId);
            resetForm();
        }

        // LOAD DRAFT FOR EDITING
        function loadDraft(draftId) {
            var draft = samples.find(function(s) { return s.id === draftId; });
            if (!draft) return;

            editingDraftId = draft.id;
            reservedSampleId = draft.sampleId;

            document.getElementById('sampleId').value = draft.sampleId;
            document.getElementById('animalType').value = draft.animalType;
            document.getElementById('sourceType').value = draft.sourceType;
            document.getElementById('healthStatus').value = draft.healthStatus;
            document.getElementById('notes').value = draft.notes;
            photos = draft.photos ? draft.photos.slice() : [];
            gpsData = draft.gps;

            showPhotos();

            if (gpsData && gpsData.lat) {
                var info = document.getElementById('gpsInfo');
                info.style.display = 'block';
                info.style.background = '#c6f6d5';
                info.textContent = '‚úì GPS: ' + gpsData.lat.toFixed(4) + ', ' + gpsData.lng.toFixed(4);
                document.getElementById('gpsBtn').textContent = '‚úì GPS Captured';
            }

            document.getElementById('draftWarning').innerHTML = '';
            goToTab('collect');
            alert('üìù Draft loaded. You can edit and submit.');
        }

        // DELETE DRAFT
        function deleteDraft(draftId) {
            if (!confirm('Delete this draft permanently?')) return;

            samples = samples.filter(function(s) { return s.id !== draftId; });
            localStorage.setItem('samples', JSON.stringify(samples));
            showSamples();
            alert('‚úÖ Draft deleted');
        }

        // SUBMIT FROM DRAFT
        function submitDraftDirectly(draftId) {
            var draft = samples.find(function(s) { return s.id === draftId; });
            if (!draft) return;

            // Convert draft to submitted
            draft.status = 'submitted';
            draft.timestamp = new Date().toISOString();
            draft.datetime = new Date().toLocaleString();

            localStorage.setItem('samples', JSON.stringify(samples));
            showSamples();
            alert('‚úÖ Draft submitted: ' + draft.sampleId);
        }

        // SUBMIT NEW SAMPLE
        function clickSubmit() {
            var animal = document.getElementById('animalType').value;
            var source = document.getElementById('sourceType').value;
            var health = document.getElementById('healthStatus').value;

            if (!animal || !source || !health) {
                alert('‚ùå Fill all required fields');
                return;
            }

            if (!gpsData) {
                alert('‚ùå Capture GPS first');
                return;
            }

            if (photos.length === 0) {
                alert('‚ùå Take at least 1 photo');
                return;
            }

            document.getElementById('submitModal').classList.add('active');
        }

        function clickCancel() {
            document.getElementById('submitModal').classList.remove('active');
        }

        function clickConfirmSubmit() {
            var sample = {
                id: editingDraftId || Date.now(),
                sampleId: reservedSampleId,
                animalType: document.getElementById('animalType').value,
                sourceType: document.getElementById('sourceType').value,
                healthStatus: document.getElementById('healthStatus').value,
                notes: document.getElementById('notes').value,
                photos: photos.slice(),
                gps: gpsData,
                collectedBy: currentUser.name,
                team: currentUser.team || null,
                timestamp: new Date().toISOString(),
                datetime: document.getElementById('datetime').value,
                status: 'submitted'
            };

            if (editingDraftId) {
                // Replace draft with submitted version
                var index = samples.findIndex(function(s) { return s.id === editingDraftId; });
                if (index >= 0) samples[index] = sample;
            } else {
                samples.push(sample);
            }

            localStorage.setItem('samples', JSON.stringify(samples));

            document.getElementById('submitModal').classList.remove('active');
            alert('‚úÖ Sample submitted: ' + reservedSampleId);

            resetForm();
            goToTab('samples');
        }

        function resetForm() {
            document.getElementById('animalType').value = '';
            document.getElementById('sourceType').value = '';
            document.getElementById('healthStatus').value = '';
            document.getElementById('notes').value = '';
            photos = [];
            gpsData = null;
            editingDraftId = null;
            showPhotos();
            document.getElementById('gpsInfo').style.display = 'none';
            document.getElementById('gpsBtn').textContent = 'üìç Capture GPS';
            document.getElementById('gpsBtn').disabled = false;
            document.getElementById('draftWarning').innerHTML = '';

            reserveNewSampleId();
            updateTime();
        }

        // SHOW SAMPLES
        function showSamples() {
            var container = document.getElementById('samplesContainer');
            var showDrafts = document.getElementById('showDrafts').checked;
            var showSubmitted = document.getElementById('showSubmitted').checked;

            var filtered = samples.filter(function(s) {
                if (s.status === 'draft' && !showDrafts) return false;
                if (s.status === 'submitted' && !showSubmitted) return false;
                if (currentUser.role !== 'admin' && s.team !== currentUser.team) return false;
                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 40px;">No samples</p>';
                return;
            }

            filtered.sort(function(a, b) {
                var aNum = parseInt(a.sampleId.replace('RM-', ''));
                var bNum = parseInt(b.sampleId.replace('RM-', ''));
                return bNum - aNum;
            });

            container.innerHTML = filtered.map(function(s) {
                var isDraft = s.status === 'draft';
                var actions = '';

                if (isDraft) {
                    actions = '<div style="margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap;">' +
                        '<button onclick="loadDraft(' + s.id + ')" class="btn-small btn-secondary">‚úèÔ∏è Edit</button>' +
                        '<button onclick="submitDraftDirectly(' + s.id + ')" class="btn-small btn-success">‚úÖ Submit</button>' +
                        '<button onclick="deleteDraft(' + s.id + ')" class="btn-small btn-danger">üóëÔ∏è Delete</button>' +
                        '</div>';
                }

                return '<div class="sample-card ' + (isDraft ? 'draft' : 'submitted') + '">' +
                    '<h3 style="color: #2563EB; margin-bottom: 15px;">' + s.sampleId + '</h3>' +
                    '<p><strong>Status:</strong> ' + (isDraft ? '‚ö†Ô∏è Draft' : '‚úÖ Submitted') + '</p>' +
                    '<p><strong>Animal:</strong> ' + s.animalType + '</p>' +
                    '<p><strong>Source:</strong> ' + s.sourceType + '</p>' +
                    (s.healthStatus ? '<p><strong>Health:</strong> ' + s.healthStatus + '</p>' : '') +
                    '<p><strong>By:</strong> ' + s.collectedBy + '</p>' +
                    (s.team ? '<p><strong>Team:</strong> ' + s.team + '</p>' : '') +
                    '<p><strong>Photos:</strong> ' + (s.photos ? s.photos.length : 0) + '</p>' +
                    (s.gps && s.gps.lat ? '<p><strong>GPS:</strong> ' + s.gps.lat.toFixed(4) + ', ' + s.gps.lng.toFixed(4) + '</p>' : '') +
                    (s.gps && s.gps.pending ? '<p style="color: #dd6b20;">‚ö†Ô∏è GPS Pending</p>' : '') +
                    '<p style="font-size: 12px; color: #718096; margin-top: 10px;">' + (s.datetime || new Date(s.timestamp).toLocaleString()) + '</p>' +
                    actions +
                    '</div>';
            }).join('');
        }

        // TABS
        function goToTab(name) {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.view').forEach(function(v) { v.classList.remove('active'); });

            if (name === 'collect') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('collectView').classList.add('active');
            } else if (name === 'samples') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('samplesView').classList.add('active');
                showSamples();
            } else if (name === 'settings') {
                document.querySelectorAll('.tab')[2].classList.add('active');
                document.getElementById('settingsView').classList.add('active');
            }
        }

        // ADD STUDENT
        function clickAddStudent() {
            var name = document.getElementById('newName').value.trim();
            var username = document.getElementById('newUsername').value.trim();
            var password = document.getElementById('newPassword').value.trim();
            var team = document.getElementById('newTeam').value;

            if (!name || !username || !password || !team) {
                alert('Fill all fields');
                return;
            }

            if (users.find(function(u) { return u.username.toLowerCase() === username.toLowerCase(); })) {
                alert('Username exists');
                return;
            }

            users.push({
                id: Date.now(),
                name: name,
                username: username.toLowerCase(),
                password: password,
                role: 'student',
                team: team
            });

            localStorage.setItem('users', JSON.stringify(users));
            alert('‚úÖ Student added: ' + name);

            document.getElementById('newName').value = '';
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newTeam').value = '';
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
