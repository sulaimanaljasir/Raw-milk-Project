<!raw-milk-tracker.html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raw Milk Project - Qassim University</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --qu-primary: #2563EB;
            --qu-secondary: #60A5FA;
            --qu-gold: #C5A572;
            --qu-dark: #1E40AF;
            --text-dark: #2d3748;
            --text-light: #718096;
            --bg-light: #f7f9fc;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--qu-primary) 0%, var(--qu-dark) 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .project-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .department-info {
            font-size: 13px;
            opacity: 0.95;
            font-weight: 400;
            line-height: 1.4;
        }

        .lang-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .lang-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: none;
            box-shadow: none;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 30px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        /* Login */
        .login-container {
            max-width: 450px;
            margin: 40px auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--qu-primary);
            box-shadow: 0 0 0 3px rgba(44, 95, 45, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: var(--qu-primary);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }

        button:hover {
            background: var(--qu-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 95, 45, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--qu-secondary);
        }

        .btn-secondary:hover {
            background: #7da64f;
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        /* Tabs */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .tab {
            background: transparent;
            color: var(--text-light);
            padding: 12px 24px;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 0;
        }

        .tab:hover {
            color: var(--qu-primary);
            transform: none;
            box-shadow: none;
        }

        .tab.active {
            color: var(--qu-primary);
            border-bottom-color: var(--qu-primary);
        }

        .view {
            display: none;
            animation: fadeIn 0.3s;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Alerts */
        .alert {
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert::before {
            content: "‚ÑπÔ∏è";
            font-size: 18px;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #38a169;
        }

        .alert-success::before {
            content: "‚úÖ";
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #e53e3e;
        }

        .alert-error::before {
            content: "‚ùå";
        }

        .alert-warning {
            background: #feebc8;
            color: #744210;
            border-left: 4px solid #dd6b20;
        }

        .alert-warning::before {
            content: "‚ö†Ô∏è";
        }

        /* User Info */
        .user-info-bar {
            background: linear-gradient(135deg, var(--qu-secondary) 0%, var(--qu-primary) 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--card-shadow);
        }

        .user-details {
            font-weight: 600;
        }

        .team-badge {
            background: rgba(255,255,255,0.3);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            margin-left: 10px;
            font-weight: 600;
        }

        /* GPS Verified Badge */
        .gps-verified {
            background: #c6f6d5;
            color: #22543d;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
        }

        .gps-verified::before {
            content: "‚úì";
            font-size: 16px;
        }

        /* Camera Button */
        .camera-btn {
            background: var(--qu-gold);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .camera-btn:hover {
            background: #b39563;
        }

        .camera-btn::before {
            content: "üì∏";
        }

        /* Photo Preview */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .photo-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Sample Cards */
        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .sample-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .sample-card:hover {
            border-color: var(--qu-secondary);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .sample-photo {
            width: 100%;
            height: 220px;
            object-fit: cover;
            background: var(--bg-light);
        }

        .sample-content {
            padding: 18px;
        }

        .sample-id {
            font-size: 20px;
            font-weight: 700;
            color: var(--qu-primary);
            margin-bottom: 12px;
        }

        .sample-info {
            font-size: 14px;
            color: var(--text-dark);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .sample-info strong {
            color: var(--text-light);
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-healthy {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-diseased {
            background: #fed7d7;
            color: #742a2a;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--qu-primary) 0%, var(--qu-secondary) 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.95;
            font-weight: 500;
        }

        /* Footer */
        .footer {
            background: var(--qu-dark);
            color: white;
            text-align: center;
            padding: 25px;
            margin-top: 50px;
            font-size: 13px;
        }

        .footer a {
            color: var(--qu-secondary);
            text-decoration: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .project-title {
                font-size: 24px;
            }

            .department-info {
                font-size: 11px;
            }

            .container {
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            .sample-grid {
                grid-template-columns: 1fr;
            }

            .tab-container {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .user-info-bar {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--qu-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hidden file input */
        input[type="file"] {
            display: none;
        }

        .verification-badge {
            background: #bee3f8;
            border-left: 4px solid #3182ce;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
            color: #2c5282;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="lang-toggle" onclick="toggleLanguage()">
            <span id="langToggle">English</span>
        </button>

        <div class="header-content">
            <h1 class="project-title" id="projectTitle">Raw Milk Project</h1>
            <p class="department-info" id="departmentInfo">
                One Health Laboratory
            </p>
        </div>
    </div>

    <!-- Login View -->
    <div id="loginView">
        <div class="container">
            <div class="login-container">
                <div class="card">
                    <h2 style="color: var(--qu-primary); margin-bottom: 25px;">Login</h2>

                    <div id="loginAlert"></div>

                    <form onsubmit="event.preventDefault(); login();">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="loginUsername" placeholder="Enter your username" autocomplete="username" required>
                        </div>

                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password" required>
                        </div>

                        <button type="submit" style="width: 100%;">Login</button>
                    </form>

                    <div class="verification-badge" style="margin-top: 20px;">
                        üîí <strong>Secure Access:</strong> GPS and photo verification enabled for data integrity
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- App View -->
    <div id="appView" style="display: none;">
        <div class="container">
            <div class="user-info-bar">
                <div class="user-details">
                    <span id="userName"></span>
                    <span id="userTeam" class="team-badge" style="display: none;"></span>
                </div>
                <button onclick="logout()" class="btn-danger" style="background: rgba(229, 62, 62, 0.9);">Logout</button>
            </div>

            <div class="card">
                <div class="tab-container">
                    <button class="tab active" onclick="switchTab('collect')">üìù Collect Sample</button>
                    <button class="tab" onclick="switchTab('samples')">üìä View Samples</button>
                    <button class="tab" onclick="switchTab('dashboard')" id="dashboardTab" style="display: none;">üìà Dashboard</button>
                    <button class="tab" onclick="switchTab('settings')" id="settingsTab" style="display: none;">‚öôÔ∏è Settings</button>
                </div>

                <!-- Collect View -->
                <div id="collectView" class="view active">
                    <h2 style="color: var(--qu-primary);">New Sample Collection</h2>

                    <form id="sampleForm" onsubmit="submitSample(event)">
                        <div class="form-group">
                            <label>Sample ID</label>
                            <input type="text" id="sampleId" readonly style="background: var(--bg-light); font-weight: 600; color: var(--qu-primary);">
                            <button type="button" onclick="generateSampleId()" class="btn-secondary" style="margin-top: 10px;">Generate New ID</button>
                        </div>

                        <div class="form-group">
                            <label>Animal Type *</label>
                            <select id="animalType" required>
                                <option value="">Select animal type</option>
                                <option value="Camel">Camel (ÿ•ÿ®ŸÑ)</option>
                                <option value="Sheep">Sheep (ÿ£ÿ∫ŸÜÿßŸÖ)</option>
                                <option value="Goat">Goat (ŸÖÿßÿπÿ≤)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Source Type *</label>
                            <select id="sourceType" required>
                                <option value="">Select source</option>
                                <option value="Farm">Farm (ŸÖÿ≤ÿ±ÿπÿ©)</option>
                                <option value="Free-ranging">Free-ranging (ÿ≥ÿßÿ¶ÿ®ÿ©)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Animal Age (years)</label>
                            <input type="number" id="animalAge" step="0.5" min="0" placeholder="e.g., 3.5">
                        </div>

                        <div class="form-group">
                            <label>Lactation Season (Number)</label>
                            <input type="number" id="lactationSeason" min="1" max="20" placeholder="1, 2, 3...">
                            <small style="color: var(--text-light); font-size: 13px;">Enter lactation number (1st, 2nd, 3rd, etc.)</small>
                        </div>

                        <div class="form-group">
                            <label>Health Status *</label>
                            <select id="healthStatus" required>
                                <option value="">Select health status</option>
                                <option value="Healthy">Healthy (ÿ≥ŸÑŸäŸÖ)</option>
                                <option value="Diseased">Diseased (ŸÖÿ±Ÿäÿ∂)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Collection Notes</label>
                            <textarea id="notes" placeholder="Any additional observations..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Sample Photos (Camera Only) *</label>
                            <p style="color: var(--text-light); font-size: 13px; margin-bottom: 10px;">
                                üì∏ Photos must be taken directly with camera for verification
                            </p>
                            <input type="file" id="photoInput" accept="image/*" capture="environment" multiple>
                            <button type="button" onclick="document.getElementById('photoInput').click()" class="camera-btn">
                                Take Photos
                            </button>
                            <div id="photoPreview" class="photo-grid"></div>
                        </div>

                        <div class="form-group">
                            <label>GPS Location (Verified) *</label>
                            <p style="color: var(--text-light); font-size: 13px; margin-bottom: 10px;">
                                üìç Location must be captured at sample collection site
                            </p>
                            <button type="button" onclick="captureVerifiedLocation()" class="btn-secondary">
                                üìç Capture Current Location
                            </button>
                            <div id="locationInfo" style="display: none;" class="gps-verified">
                                Location verified and captured
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Collection Date & Time</label>
                            <input type="text" id="collectionDateTime" readonly style="background: var(--bg-light);">
                            <small style="color: var(--text-light); font-size: 13px;">Automatically recorded</small>
                        </div>

                        <button type="submit" style="width: 100%; margin-top: 20px; font-size: 18px; padding: 16px;">
                            üíæ Save Sample
                        </button>
                    </form>
                </div>

                <!-- Samples View -->
                <div id="samplesView" class="view">
                    <h2 style="color: var(--qu-primary);">Sample Records</h2>

                    <div style="display: flex; gap: 12px; margin: 20px 0; flex-wrap: wrap;">
                        <select id="filterAnimal" onchange="filterSamples()" style="flex: 1; min-width: 150px;">
                            <option value="">All Animals</option>
                            <option value="Camel">Camel</option>
                            <option value="Sheep">Sheep</option>
                            <option value="Goat">Goat</option>
                        </select>
                        <select id="filterTeam" onchange="filterSamples()" style="flex: 1; min-width: 150px; display: none;">
                            <option value="">All Teams</option>
                        </select>
                        <button onclick="exportToExcel()" class="btn-secondary">üì• Export to Excel</button>
                    </div>

                    <div id="samplesContainer" class="sample-grid"></div>
                </div>

                <!-- Dashboard View -->
                <div id="dashboardView" class="view">
                    <h2 style="color: var(--qu-primary);">Dashboard & Analytics</h2>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalSamples">0</div>
                            <div class="stat-label">Total Samples</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);">
                            <div class="stat-number" id="totalCamels">0</div>
                            <div class="stat-label">Camel Samples</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #4A5568 0%, #718096 100%);">
                            <div class="stat-number" id="totalSheep">0</div>
                            <div class="stat-label">Sheep Samples</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #744210 0%, #9C6644 100%);">
                            <div class="stat-number" id="totalGoats">0</div>
                            <div class="stat-label">Goat Samples</div>
                        </div>
                    </div>

                    <div style="margin-top: 40px;">
                        <h3 style="color: var(--qu-primary); margin-bottom: 15px;">Team Progress</h3>
                        <div id="teamProgress"></div>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="settingsView" class="view">
                    <h2 style="color: var(--qu-primary);">Admin Settings</h2>

                    <div class="alert alert-warning">
                        ‚ö†Ô∏è <strong>Admin Access Only:</strong> These settings control the entire system
                    </div>

                    <!-- Backup Section -->
                    <h3 style="margin-top: 30px; color: var(--qu-primary);">üíæ Data Backup & Cloud Sync</h3>
                    <div class="card" style="margin-bottom: 20px;">
                        <p style="color: var(--text-light); margin-bottom: 15px;">
                            <strong>Cloud Storage:</strong> <a href="https://quedusa.sharepoint.com/:f:/s/AlUlaproject/IgDYTagisFsrQrnCClX7tY2XAW0-6dDprDYBkUBIUOD5HdY?e=BM6OQz" target="_blank" style="color: var(--qu-primary); text-decoration: none; padding: 8px 16px; background: #E6F7FF; border-radius: 5px; display: inline-block;">üìÅ Open SharePoint Folder ‚Üí</a>
                        </p>
                        <div id="backupIndicator" style="display: none; margin-bottom: 15px; padding: 10px; background: #E6F7FF; border-left: 4px solid var(--qu-primary); color: var(--text-dark);"></div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <button onclick="downloadBackup()" class="btn-secondary" style="width: 100%;">
                                üì• Download Backup File
                            </button>
                            <button onclick="restoreFromBackup()" class="btn-secondary" style="width: 100%;">
                                üì§ Restore from Backup
                            </button>
                            <button onclick="exportToExcel()" class="btn-secondary" style="width: 100%;">
                                üìä Export Excel
                            </button>
                        </div>
                        <p style="margin-top: 15px; font-size: 13px; color: var(--text-light);">
                            üí° <strong>Tip:</strong> Download backup files and upload them to your SharePoint folder for cloud storage. Automatic sync can be enabled with Azure credentials.
                        </p>
                    </div>

                    <h3 style="margin-top: 30px; color: var(--qu-primary);">Manage Students & Teams</h3>
                    <div id="studentsList"></div>

                    <h3 style="margin-top: 30px; color: var(--qu-primary);">Add New Student</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <input type="text" id="newStudentName" placeholder="Student name">
                        <input type="text" id="newStudentUsername" placeholder="Username">
                        <input type="password" id="newStudentPassword" placeholder="Password">
                        <select id="newStudentTeam">
                            <option value="Team A">Team A</option>
                            <option value="Team B">Team B</option>
                            <option value="Team C">Team C</option>
                            <option value="Team D">Team D</option>
                        </select>
                    </div>
                    <button onclick="addStudent()" class="btn-secondary" style="margin-top: 15px;">Add Student</button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p><strong>Raw Milk Project</strong> | One Health Laboratory</p>
        <p>Department of Preventive Veterinary Medicine</p>
        <p>College of Veterinary Medicine, Qassim University</p>
        <p style="margin-top: 10px; font-size: 12px;">¬© 2026 All Rights Reserved</p>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let samples = [];
        let users = [];
        let currentLocation = null;
        let locationCaptureTime = null;
        let capturedPhotos = [];

        // Initialize
        function initializeApp() {
            users = JSON.parse(localStorage.getItem('users')) || [
                {
                    id: 1,
                    name: 'Dr. Sulaiman Aljasir',
                    username: 'sulaiman',
                    password: 'Project26',
                    role: 'admin',
                    permissions: ['all'],
                    team: null
                },
                {
                    id: 2,
                    name: 'Ibrahim',
                    username: 'ibrahim',
                    password: '33016033',
                    role: 'admin',
                    permissions: ['view_data', 'export_data', 'view_dashboard'],
                    team: null
                },
                {
                    id: 3,
                    name: 'Imran',
                    username: 'imran',
                    password: '44017044',
                    role: 'admin',
                    permissions: ['view_data', 'export_data', 'view_dashboard'],
                    team: null
                }
            ];

            samples = JSON.parse(localStorage.getItem('samples')) || [];
            generateSampleId();
            updateCollectionDateTime();

            // Photo input handler
            document.getElementById('photoInput').addEventListener('change', handlePhotoCapture);
        }

        // Login with username
        function login() {
            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;

            console.log('Login attempt:', { username, passwordLength: password.length });
            console.log('Available users:', users.map(u => ({ username: u.username, hasPassword: !!u.password })));

            const user = users.find(u => u.username.toLowerCase() === username && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showAlert('‚úÖ Login successful!', 'success', 'loginAlert');
                setTimeout(() => {
                    document.getElementById('loginView').style.display = 'none';
                    document.getElementById('appView').style.display = 'block';
                    showApp();
                }, 800);
            } else {
                console.log('Login failed - user not found or password mismatch');
                showAlert('‚ùå Invalid username or password', 'error', 'loginAlert');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            location.reload();
        }

        function showApp() {
            document.getElementById('userName').textContent = currentUser.name;

            if (currentUser.team) {
                document.getElementById('userTeam').textContent = currentUser.team;
                document.getElementById('userTeam').style.display = 'inline-block';
            }

            if (currentUser.role === 'admin') {
                document.getElementById('dashboardTab').style.display = 'block';
                if (currentUser.permissions.includes('all')) {
                    document.getElementById('settingsTab').style.display = 'block';
                }
                document.getElementById('filterTeam').style.display = 'block';
            }

            renderSamples();
            updateDashboard();
        }

        // VERIFIED GPS CAPTURE - Real-time only
        function captureVerifiedLocation() {
            if (!navigator.geolocation) {
                alert('‚ùå GPS not supported by your device');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'üìç Getting location...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const accuracy = position.coords.accuracy;

                    if (accuracy > 50) {
                        alert(`‚ö†Ô∏è GPS accuracy is ${accuracy.toFixed(0)}m. Please wait for better signal (< 50m)`);
                        btn.disabled = false;
                        btn.textContent = 'üìç Capture Current Location';
                        return;
                    }

                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: accuracy,
                        timestamp: new Date().toISOString(),
                        verified: true
                    };

                    locationCaptureTime = Date.now();

                    document.getElementById('locationInfo').style.display = 'block';
                    document.getElementById('locationInfo').innerHTML = `
                        ‚úì Location verified<br>
                        Lat: ${currentLocation.latitude.toFixed(6)}<br>
                        Lng: ${currentLocation.longitude.toFixed(6)}<br>
                        Accuracy: ¬±${accuracy.toFixed(0)}m
                    `;

                    btn.disabled = false;
                    btn.textContent = '‚úì Location Captured';
                    btn.style.background = '#38a169';
                },
                (error) => {
                    alert(`‚ùå GPS Error: ${error.message}`);
                    btn.disabled = false;
                    btn.textContent = 'üìç Capture Current Location';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // VERIFIED PHOTO CAPTURE - Camera only
        function handlePhotoCapture(event) {
            const files = Array.from(event.target.files);
            capturedPhotos = [];

            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    capturedPhotos.push({
                        data: e.target.result,
                        timestamp: new Date().toISOString(),
                        verified: true
                    });

                    const div = document.createElement('div');
                    div.className = 'photo-item';
                    div.innerHTML = `<img src="${e.target.result}" alt="Photo ${index + 1}">`;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // Generate Sample ID - Simple sequential numbering
        function generateSampleId() {
            // Get next sample number
            const nextNumber = samples.length + 1;
            document.getElementById('sampleId').value = `RM-${nextNumber}`;
            updateCollectionDateTime();
        }

        function updateCollectionDateTime() {
            const now = new Date();
            document.getElementById('collectionDateTime').value = now.toLocaleString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Submit Sample with Verification
        function submitSample(event) {
            event.preventDefault();

            // Verify GPS
            if (!currentLocation || !locationCaptureTime) {
                alert('‚ùå Please capture GPS location first');
                return;
            }

            const locationAge = (Date.now() - locationCaptureTime) / 1000 / 60;
            if (locationAge > 5) {
                alert('‚ùå GPS location expired. Please capture fresh location (within 5 minutes)');
                return;
            }

            // Verify Photos
            if (capturedPhotos.length === 0) {
                alert('‚ùå Please take at least one photo with camera');
                return;
            }

            const now = new Date();
            const sample = {
                id: Date.now(),
                sampleId: document.getElementById('sampleId').value,
                animalType: document.getElementById('animalType').value,
                sourceType: document.getElementById('sourceType').value,
                animalAge: document.getElementById('animalAge').value,
                lactationSeason: document.getElementById('lactationSeason').value,
                healthStatus: document.getElementById('healthStatus').value,
                notes: document.getElementById('notes').value,
                photos: capturedPhotos,
                location: currentLocation,
                collectedBy: currentUser.name,
                team: currentUser.team,
                timestamp: now.toISOString(),
                collectionDateTime: now.toLocaleString(),
                verified: true,
                version: "1.0"
            };

            samples.push(sample);
            localStorage.setItem('samples', JSON.stringify(samples));

            // Auto-backup after each sample
            autoBackup();

            alert('‚úÖ Sample saved successfully with verification!');

            document.getElementById('sampleForm').reset();
            generateSampleId();
            currentLocation = null;
            locationCaptureTime = null;
            capturedPhotos = [];
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('locationInfo').style.display = 'none';
        }

        // Automatic Backup Functions
        function autoBackup() {
            // Save backup timestamp
            const lastBackup = new Date().toISOString();
            localStorage.setItem('lastBackup', lastBackup);

            // Update backup indicator
            updateBackupIndicator();
        }

        function updateBackupIndicator() {
            const lastBackup = localStorage.getItem('lastBackup');
            if (lastBackup) {
                const date = new Date(lastBackup);
                const timeAgo = getTimeAgo(date);
                const indicator = document.getElementById('backupIndicator');
                if (indicator) {
                    indicator.textContent = `üíæ Last backup: ${timeAgo}`;
                    indicator.style.display = 'block';
                }
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            const days = Math.floor(hours / 24);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        function downloadBackup() {
            const backupData = {
                samples: samples,
                users: users.map(u => ({...u, password: '***'})), // Don't include passwords in backup
                exportDate: new Date().toISOString(),
                version: '1.0',
                projectInfo: {
                    name: 'Raw Milk Project',
                    institution: 'Qassim University',
                    department: 'Department of Preventive Veterinary Medicine'
                }
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            const time = new Date().toISOString().split('T')[1].split('.')[0].replace(/:/g, '-');
            a.href = url;
            a.download = `raw-milk-backup-${date}-${time}.json`;
            a.click();

            alert('‚úÖ Backup file downloaded! Upload this to your SharePoint folder.');
        }

        function restoreFromBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const backup = JSON.parse(event.target.result);

                        if (confirm(`Restore ${backup.samples.length} samples from backup dated ${new Date(backup.exportDate).toLocaleString()}?\n\nWarning: This will replace current data!`)) {
                            samples = backup.samples || [];
                            localStorage.setItem('samples', JSON.stringify(samples));

                            alert('‚úÖ Backup restored successfully!');
                            renderSamples();
                            updateDashboard();
                        }
                    } catch (error) {
                        alert('‚ùå Invalid backup file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Render Samples
        function renderSamples() {
            const container = document.getElementById('samplesContainer');
            let filteredSamples = [...samples];

            if (currentUser.role === 'student') {
                filteredSamples = filteredSamples.filter(s => s.team === currentUser.team);
            }

            const animalFilter = document.getElementById('filterAnimal').value;
            if (animalFilter) {
                filteredSamples = filteredSamples.filter(s => s.animalType === animalFilter);
            }

            container.innerHTML = filteredSamples.map(sample => `
                <div class="sample-card">
                    ${sample.photos && sample.photos[0] ?
                        `<img src="${sample.photos[0].data || sample.photos[0]}" alt="Sample" class="sample-photo">` :
                        '<div class="sample-photo" style="display: flex; align-items: center; justify-content: center; color: var(--text-light);">No Photo</div>'
                    }
                    <div class="sample-content">
                        <div class="sample-id">${sample.sampleId}</div>
                        <div class="sample-info">
                            <strong>Animal:</strong>
                            <span>${sample.animalType}</span>
                        </div>
                        <div class="sample-info">
                            <strong>Source:</strong>
                            <span>${sample.sourceType}</span>
                        </div>
                        <div class="sample-info">
                            <strong>Health:</strong>
                            <span class="status-badge status-${sample.healthStatus.toLowerCase()}">${sample.healthStatus}</span>
                        </div>
                        <div class="sample-info">
                            <strong>Team:</strong>
                            <span>${sample.team || 'N/A'}</span>
                        </div>
                        <div class="sample-info">
                            <strong>Date:</strong>
                            <span>${sample.collectionDateTime || new Date(sample.timestamp).toLocaleDateString()}</span>
                        </div>
                        ${sample.location ? `
                            <div class="sample-info">
                                <strong>GPS:</strong>
                                <span>${sample.location.latitude.toFixed(4)}, ${sample.location.longitude.toFixed(4)}</span>
                            </div>
                        ` : ''}
                        ${sample.verified ? '<div class="gps-verified" style="margin-top: 10px; font-size: 11px;">‚úì Verified Sample</div>' : ''}
                    </div>
                </div>
            `).join('');
        }

        function filterSamples() {
            renderSamples();
        }

        // Dashboard
        function updateDashboard() {
            document.getElementById('totalSamples').textContent = samples.length;
            document.getElementById('totalCamels').textContent = samples.filter(s => s.animalType === 'Camel').length;
            document.getElementById('totalSheep').textContent = samples.filter(s => s.animalType === 'Sheep').length;
            document.getElementById('totalGoats').textContent = samples.filter(s => s.animalType === 'Goat').length;
        }

        // Export
        function exportToExcel() {
            let exportSamples = samples;
            if (currentUser.role === 'student') {
                exportSamples = samples.filter(s => s.team === currentUser.team);
            }

            let csv = 'Sample ID,Animal Type,Source,Age,Lactation Season,Health Status,Notes,Collected By,Team,Date/Time,Latitude,Longitude,Verified\n';

            exportSamples.forEach(sample => {
                csv += `"${sample.sampleId}","${sample.animalType}","${sample.sourceType}",`;
                csv += `"${sample.animalAge}","${sample.lactationSeason || ''}","${sample.healthStatus}",`;
                csv += `"${sample.notes}","${sample.collectedBy}","${sample.team || ''}",`;
                csv += `"${sample.collectionDateTime || new Date(sample.timestamp).toLocaleString()}",`;
                csv += `"${sample.location ? sample.location.latitude : ''}",`;
                csv += `"${sample.location ? sample.location.longitude : ''}",`;
                csv += `"${sample.verified ? 'Yes' : 'No'}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `raw-milk-samples-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();

            alert(`‚úÖ Exported ${exportSamples.length} samples to Excel`);
        }

        // Tab Navigation
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'View').classList.add('active');

            if (tabName === 'samples') renderSamples();
            if (tabName === 'dashboard') updateDashboard();
        }

        // Alerts
        function showAlert(message, type, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }

        // Language Toggle
        let currentLang = 'en';

        const translations = {
            en: {
                // Header
                langToggle: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
                projectTitle: 'Raw Milk Project',
                departmentInfo: 'One Health Laboratory',

                // Login
                loginTitle: 'Login',
                username: 'Username',
                password: 'Password',
                loginBtn: 'Login',

                // Navigation Tabs
                tabCollection: 'Collection',
                tabSamples: 'Samples',
                tabDashboard: 'Dashboard',
                tabSettings: 'Settings',

                // Collection Form
                formTitle: 'New Sample Collection',
                sampleId: 'Sample ID',
                generateId: 'Generate New ID',
                animalType: 'Animal Type',
                selectAnimal: 'Select animal type',
                camel: 'Camel',
                sheep: 'Sheep',
                goat: 'Goat',
                sourceType: 'Source Type',
                selectSource: 'Select source',
                farm: 'Farm',
                freeRanging: 'Free-ranging',
                animalAge: 'Animal Age (years)',
                lactationSeason: 'Lactation Season (number)',
                healthStatus: 'Health Status',
                selectHealth: 'Select health status',
                healthy: 'Healthy',
                diseased: 'Diseased',
                notes: 'Notes (Optional)',
                notesPlaceholder: 'Any additional observations...',
                photos: 'Photos',
                takePhotos: 'Take Photos',
                location: 'Location (GPS)',
                captureLocation: 'üìç Capture Current Location',
                collectionTime: 'Collection Date & Time',
                submitSample: 'Submit Sample',

                // Samples View
                samplesTitle: 'Sample Records',
                exportExcel: 'Export to Excel',
                search: 'Search samples...',
                filterTeam: 'Filter by team',
                allTeams: 'All Teams',

                // Dashboard
                dashboardTitle: 'Project Dashboard',
                totalSamples: 'Total Samples',
                byAnimal: 'By Animal Type',
                bySource: 'By Source Type',
                byHealth: 'By Health Status',
                byTeam: 'By Team',

                // Settings
                settingsTitle: 'System Settings',
                addStudent: 'Add New Student',
                studentName: 'Student Name',
                studentUsername: 'Username',
                studentPassword: 'Password',
                studentTeam: 'Team',
                addStudentBtn: 'Add Student',
                logout: 'Logout',

                // Footer
                footerProject: 'Raw Milk Project',
                footerLab: 'One Health Laboratory',
                footerDept: 'Department of Preventive Veterinary Medicine',
                footerCollege: 'College of Veterinary Medicine, Qassim University',
                footerCopyright: '¬© 2026 All Rights Reserved'
            },
            ar: {
                // Header
                langToggle: 'English',
                projectTitle: 'ŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ≠ŸÑŸäÿ® ÿßŸÑÿÆÿßŸÖ',
                departmentInfo: 'ŸÖÿÆÿ™ÿ®ÿ± ÿßŸÑÿµÿ≠ÿ© ÿßŸÑŸàÿßÿ≠ÿØÿ©',

                // Login
                loginTitle: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ',
                username: 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
                password: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±',
                loginBtn: 'ÿØÿÆŸàŸÑ',

                // Navigation Tabs
                tabCollection: 'ÿ¨ŸÖÿπ ÿßŸÑÿπŸäŸÜÿßÿ™',
                tabSamples: 'ÿßŸÑÿπŸäŸÜÿßÿ™',
                tabDashboard: 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ',
                tabSettings: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',

                // Collection Form
                formTitle: 'ÿ¨ŸÖÿπ ÿπŸäŸÜÿ© ÿ¨ÿØŸäÿØÿ©',
                sampleId: 'ÿ±ŸÇŸÖ ÿßŸÑÿπŸäŸÜÿ©',
                generateId: 'ÿ™ŸàŸÑŸäÿØ ÿ±ŸÇŸÖ ÿ¨ÿØŸäÿØ',
                animalType: 'ŸÜŸàÿπ ÿßŸÑÿ≠ŸäŸàÿßŸÜ',
                selectAnimal: 'ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ≠ŸäŸàÿßŸÜ',
                camel: 'ÿ•ÿ®ŸÑ',
                sheep: 'ÿ£ÿ∫ŸÜÿßŸÖ',
                goat: 'ŸÖÿßÿπÿ≤',
                sourceType: 'ŸÜŸàÿπ ÿßŸÑŸÖÿµÿØÿ±',
                selectSource: 'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿµÿØÿ±',
                farm: 'ŸÖÿ≤ÿ±ÿπÿ©',
                freeRanging: 'ÿ≥ÿßÿ¶ÿ®ÿ©',
                animalAge: 'ÿπŸÖÿ± ÿßŸÑÿ≠ŸäŸàÿßŸÜ (ÿ®ÿßŸÑÿ≥ŸÜŸàÿßÿ™)',
                lactationSeason: 'ŸÖŸàÿ≥ŸÖ ÿßŸÑÿ•ÿ±ÿ∂ÿßÿπ (ÿ±ŸÇŸÖ)',
                healthStatus: 'ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿµÿ≠Ÿäÿ©',
                selectHealth: 'ÿßÿÆÿ™ÿ± ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿµÿ≠Ÿäÿ©',
                healthy: 'ÿ≥ŸÑŸäŸÖ',
                diseased: 'ŸÖÿ±Ÿäÿ∂',
                notes: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)',
                notesPlaceholder: 'ÿ£Ÿä ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©...',
                photos: 'ÿßŸÑÿµŸàÿ±',
                takePhotos: 'ÿßŸÑÿ™ŸÇÿßÿ∑ ÿµŸàÿ±',
                location: 'ÿßŸÑŸÖŸàŸÇÿπ (GPS)',
                captureLocation: 'üìç ÿßŸÑÿ™ŸÇÿßÿ∑ ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ≠ÿßŸÑŸä',
                collectionTime: 'ÿ™ÿßÿ±ŸäÿÆ ŸàŸàŸÇÿ™ ÿßŸÑÿ¨ŸÖÿπ',
                submitSample: 'ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿπŸäŸÜÿ©',

                // Samples View
                samplesTitle: 'ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿπŸäŸÜÿßÿ™',
                exportExcel: 'ÿ™ÿµÿØŸäÿ± ÿ•ŸÑŸâ Excel',
                search: 'ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿπŸäŸÜÿßÿ™...',
                filterTeam: 'ÿ™ÿµŸÅŸäÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÅÿ±ŸäŸÇ',
                allTeams: 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ±ŸÇ',

                // Dashboard
                dashboardTitle: 'ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ',
                totalSamples: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿπŸäŸÜÿßÿ™',
                byAnimal: 'ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ≠ŸäŸàÿßŸÜ',
                bySource: 'ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑŸÖÿµÿØÿ±',
                byHealth: 'ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿµÿ≠Ÿäÿ©',
                byTeam: 'ÿ≠ÿ≥ÿ® ÿßŸÑŸÅÿ±ŸäŸÇ',

                // Settings
                settingsTitle: 'ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ',
                addStudent: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ∑ÿßŸÑÿ® ÿ¨ÿØŸäÿØ',
                studentName: 'ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ®',
                studentUsername: 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
                studentPassword: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±',
                studentTeam: 'ÿßŸÑŸÅÿ±ŸäŸÇ',
                addStudentBtn: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ∑ÿßŸÑÿ®',
                logout: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨',

                // Footer
                footerProject: 'ŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ≠ŸÑŸäÿ® ÿßŸÑÿÆÿßŸÖ',
                footerLab: 'ŸÖÿÆÿ™ÿ®ÿ± ÿßŸÑÿµÿ≠ÿ© ÿßŸÑŸàÿßÿ≠ÿØÿ©',
                footerDept: 'ŸÇÿ≥ŸÖ ÿßŸÑÿ∑ÿ® ÿßŸÑŸàŸÇÿßÿ¶Ÿä ÿßŸÑÿ®Ÿäÿ∑ÿ±Ÿä',
                footerCollege: 'ŸÉŸÑŸäÿ© ÿßŸÑÿ∑ÿ® ÿßŸÑÿ®Ÿäÿ∑ÿ±Ÿäÿå ÿ¨ÿßŸÖÿπÿ© ÿßŸÑŸÇÿµŸäŸÖ',
                footerCopyright: '¬© 2026 ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ©'
            }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            updateLanguage();
        }

        function updateLanguage() {
            const t = translations[currentLang];
            const isArabic = currentLang === 'ar';

            // Update HTML direction
            document.documentElement.setAttribute('lang', currentLang);
            document.documentElement.setAttribute('dir', isArabic ? 'rtl' : 'ltr');

            // Update language toggle button
            const langToggleEl = document.getElementById('langToggle');
            if (langToggleEl) langToggleEl.textContent = t.langToggle;

            // Update header
            const projectTitle = document.querySelector('.project-title');
            const deptInfo = document.querySelector('.department-info');
            if (projectTitle) projectTitle.textContent = t.projectTitle;
            if (deptInfo) deptInfo.textContent = t.departmentInfo;

            // Update login page
            const loginTitle = document.querySelector('#loginView h2');
            if (loginTitle) loginTitle.textContent = t.loginTitle;

            const loginLabels = document.querySelectorAll('#loginView label');
            if (loginLabels.length >= 2) {
                loginLabels[0].textContent = t.username;
                loginLabels[1].textContent = t.password;
            }

            const loginBtn = document.querySelector('#loginView button[type="submit"]');
            if (loginBtn) loginBtn.textContent = t.loginBtn;

            // Update navigation tabs
            const tabs = document.querySelectorAll('.tab');
            if (tabs.length >= 4) {
                tabs[0].textContent = t.tabCollection;
                tabs[1].textContent = t.tabSamples;
                tabs[2].textContent = t.tabDashboard;
                tabs[3].textContent = t.tabSettings;
            }

            // Update collection form
            updateElementText('h3', 0, t.formTitle);

            // Update form labels by selecting them in order
            const formLabels = document.querySelectorAll('#collectionView label');
            const labelMapping = [
                t.sampleId,
                t.animalType,
                t.sourceType,
                t.animalAge,
                t.lactationSeason,
                t.healthStatus,
                t.notes,
                t.photos,
                t.location,
                t.collectionTime
            ];

            formLabels.forEach((label, index) => {
                if (labelMapping[index]) {
                    label.textContent = labelMapping[index] + (index < 6 ? ' *' : '');
                }
            });

            // Update select options
            updateSelectOption('animalType', 0, t.selectAnimal);
            updateSelectOption('animalType', 1, t.camel + ' (Camel)');
            updateSelectOption('animalType', 2, t.sheep + ' (Sheep)');
            updateSelectOption('animalType', 3, t.goat + ' (Goat)');

            updateSelectOption('sourceType', 0, t.selectSource);
            updateSelectOption('sourceType', 1, t.farm + ' (Farm)');
            updateSelectOption('sourceType', 2, t.freeRanging + ' (Free-ranging)');

            updateSelectOption('healthStatus', 0, t.selectHealth);
            updateSelectOption('healthStatus', 1, t.healthy);
            updateSelectOption('healthStatus', 2, t.diseased);

            // Update buttons
            const generateIdBtn = document.querySelector('button[onclick="generateSampleId()"]');
            if (generateIdBtn) generateIdBtn.textContent = t.generateId;

            const takePhotosBtn = document.querySelector('.camera-btn');
            if (takePhotosBtn) takePhotosBtn.textContent = 'üì∑ ' + t.takePhotos;

            const captureLocBtn = document.querySelector('button[onclick="captureVerifiedLocation()"]');
            if (captureLocBtn && !captureLocBtn.disabled) {
                captureLocBtn.textContent = t.captureLocation;
            }

            const submitBtn = document.querySelector('#sampleForm button[type="submit"]');
            if (submitBtn) submitBtn.textContent = t.submitSample;

            // Update samples view
            const samplesTitle = document.querySelector('#samplesView h3');
            if (samplesTitle) samplesTitle.textContent = t.samplesTitle;

            const exportBtn = document.querySelector('button[onclick="exportToExcel()"]');
            if (exportBtn) exportBtn.textContent = 'üìä ' + t.exportExcel;

            const searchInput = document.getElementById('searchSamples');
            if (searchInput) searchInput.placeholder = t.search;

            const teamFilter = document.getElementById('teamFilter');
            if (teamFilter && teamFilter.options.length > 0) {
                teamFilter.options[0].textContent = t.allTeams;
            }

            // Update dashboard
            const dashTitle = document.querySelector('#dashboardView h3');
            if (dashTitle) dashTitle.textContent = t.dashboardTitle;

            // Update settings
            const settingsTitle = document.querySelector('#settingsView h3');
            if (settingsTitle) settingsTitle.textContent = t.settingsTitle;

            const settingsLabels = document.querySelectorAll('#settingsView label');
            if (settingsLabels.length >= 4) {
                settingsLabels[0].textContent = t.studentName;
                settingsLabels[1].textContent = t.studentUsername;
                settingsLabels[2].textContent = t.studentPassword;
                settingsLabels[3].textContent = t.studentTeam;
            }

            const addStudentBtn = document.querySelector('button[onclick="addStudent()"]');
            if (addStudentBtn) addStudentBtn.textContent = t.addStudentBtn;

            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            if (logoutBtn) logoutBtn.textContent = 'üö™ ' + t.logout;

            // Update footer
            const footerPs = document.querySelectorAll('.footer p');
            if (footerPs.length >= 4) {
                footerPs[0].innerHTML = `<strong>${t.footerProject}</strong> | ${t.footerLab}`;
                footerPs[1].textContent = t.footerDept;
                footerPs[2].textContent = t.footerCollege;
                footerPs[3].textContent = t.footerCopyright;
            }

            // Adjust text alignment for Arabic
            if (isArabic) {
                document.body.style.textAlign = 'right';
                document.querySelectorAll('.card').forEach(card => {
                    card.style.textAlign = 'right';
                });
            } else {
                document.body.style.textAlign = 'left';
                document.querySelectorAll('.card').forEach(card => {
                    card.style.textAlign = 'left';
                });
            }
        }

        function updateElementText(selector, index, text) {
            const elements = document.querySelectorAll(selector);
            if (elements[index]) elements[index].textContent = text;
        }

        function updateSelectOption(selectId, optionIndex, text) {
            const select = document.getElementById(selectId);
            if (select && select.options[optionIndex]) {
                select.options[optionIndex].textContent = text;
            }
        }

        // Student Management (Admin only)
        function addStudent() {
            if (!currentUser.permissions.includes('all')) {
                alert('‚ùå Insufficient permissions');
                return;
            }

            const name = document.getElementById('newStudentName').value;
            const username = document.getElementById('newStudentUsername').value;
            const password = document.getElementById('newStudentPassword').value;
            const team = document.getElementById('newStudentTeam').value;

            if (!name || !username || !password) {
                alert('Please fill all fields');
                return;
            }

            users.push({
                id: Date.now(),
                name,
                username: username.toLowerCase(),
                password,
                role: 'student',
                team
            });

            localStorage.setItem('users', JSON.stringify(users));
            alert('‚úÖ Student added successfully!');
            document.getElementById('newStudentName').value = '';
            document.getElementById('newStudentUsername').value = '';
            document.getElementById('newStudentPassword').value = '';
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initializeApp();
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('loginView').style.display = 'none';
                document.getElementById('appView').style.display = 'block';
                showApp();
            }

            // Update backup indicator every minute
            updateBackupIndicator();
            setInterval(updateBackupIndicator, 60000);

            // Daily backup reminder
            checkDailyBackupReminder();
        });

        function checkDailyBackupReminder() {
            const lastReminder = localStorage.getItem('lastBackupReminder');
            const today = new Date().toDateString();

            if (lastReminder !== today && samples.length > 0) {
                const lastBackup = localStorage.getItem('lastBackup');
                if (!lastBackup) {
                    setTimeout(() => {
                        if (confirm('üì• Daily Backup Reminder\n\nYou have ' + samples.length + ' samples collected. Would you like to download a backup file now?')) {
                            downloadBackup();
                        }
                        localStorage.setItem('lastBackupReminder', today);
                    }, 2000); // Show after 2 seconds
                } else {
                    const lastBackupDate = new Date(lastBackup).toDateString();
                    if (lastBackupDate !== today) {
                        setTimeout(() => {
                            if (confirm('üì• Daily Backup Reminder\n\nYour last backup was ' + getTimeAgo(new Date(lastBackup)) + '. Would you like to download a fresh backup file?')) {
                                downloadBackup();
                            }
                            localStorage.setItem('lastBackupReminder', today);
                        }, 2000);
                    }
                }
            }
        }
    </script>
</body>
</html>
