<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raw Milk Project - Qassim University</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --qu-primary: #2563EB;
            --qu-secondary: #60A5FA;
            --qu-gold: #C5A572;
            --qu-dark: #1E40AF;
            --text-dark: #2d3748;
            --text-light: #718096;
            --bg-light: #f7f9fc;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--qu-primary) 0%, var(--qu-dark) 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .project-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .department-info {
            font-size: 13px;
            opacity: 0.95;
            font-weight: 400;
            line-height: 1.4;
        }

        .lang-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .lang-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 30px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        /* Login */
        .login-container {
            max-width: 450px;
            margin: 40px auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--qu-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: var(--qu-primary);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }

        button:hover {
            background: var(--qu-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--qu-secondary);
        }

        .btn-secondary:hover {
            background: #3b82f6;
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn-success {
            background: #38a169;
        }

        .btn-success:hover {
            background: #2f855a;
        }

        /* Tabs */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .tab {
            background: transparent;
            color: var(--text-light);
            padding: 12px 24px;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 0;
        }

        .tab:hover {
            color: var(--qu-primary);
            transform: none;
            box-shadow: none;
        }

        .tab.active {
            color: var(--qu-primary);
            border-bottom-color: var(--qu-primary);
        }

        .view {
            display: none;
            animation: fadeIn 0.3s;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Alerts */
        .alert {
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #38a169;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #e53e3e;
        }

        .alert-warning {
            background: #feebc8;
            color: #744210;
            border-left: 4px solid #dd6b20;
        }

        /* User Info */
        .user-info-bar {
            background: linear-gradient(135deg, var(--qu-secondary) 0%, var(--qu-primary) 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--card-shadow);
        }

        .user-details {
            font-weight: 600;
        }

        .team-badge {
            background: rgba(255,255,255,0.3);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            margin-left: 10px;
            font-weight: 600;
        }

        /* GPS Verified Badge */
        .gps-verified {
            background: #c6f6d5;
            color: #22543d;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
        }

        .gps-verified::before {
            content: "‚úì";
            font-size: 16px;
        }

        /* Camera Button */
        .camera-btn {
            background: var(--qu-gold);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .camera-btn:hover {
            background: #b39563;
        }

        .camera-btn::before {
            content: "üì∏";
        }

        /* Photo Preview */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .photo-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(229, 62, 62, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Sample Cards */
        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .sample-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .sample-card:hover {
            border-color: var(--qu-secondary);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .sample-photo {
            width: 100%;
            height: 220px;
            object-fit: cover;
            background: var(--bg-light);
        }

        .sample-content {
            padding: 18px;
        }

        .sample-id {
            font-size: 20px;
            font-weight: 700;
            color: var(--qu-primary);
            margin-bottom: 12px;
        }

        .sample-info {
            font-size: 14px;
            color: var(--text-dark);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .sample-info strong {
            color: var(--text-light);
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-healthy {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-diseased {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-pending {
            background: #feebc8;
            color: #744210;
        }

        .status-submitted {
            background: #bee3f8;
            color: #2c5282;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--qu-primary) 0%, var(--qu-secondary) 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.95;
            font-weight: 500;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        /* Footer */
        .footer {
            background: var(--qu-dark);
            color: white;
            text-align: center;
            padding: 25px;
            margin-top: 50px;
            font-size: 13px;
        }

        .footer a {
            color: var(--qu-secondary);
            text-decoration: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .project-title {
                font-size: 24px;
            }

            .department-info {
                font-size: 11px;
            }

            .container {
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            .sample-grid {
                grid-template-columns: 1fr;
            }

            .tab-container {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .user-info-bar {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--qu-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hidden file input */
        input[type="file"] {
            display: none;
        }

        .verification-badge {
            background: #bee3f8;
            border-left: 4px solid #3182ce;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
            color: #2c5282;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="lang-toggle" onclick="toggleLanguage()">
            <span id="langToggle">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</span>
        </button>

        <div class="header-content">
            <h1 class="project-title" id="projectTitle">Raw Milk Project</h1>
            <p class="department-info" id="departmentInfo">
                One Health Laboratory
            </p>
        </div>
    </div>

    <!-- Login View -->
    <div id="loginView">
        <div class="container">
            <div class="login-container">
                <div class="card">
                    <h2 style="color: var(--qu-primary); margin-bottom: 25px;">Login</h2>

                    <div id="loginAlert"></div>

                    <form onsubmit="event.preventDefault(); login();">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="loginUsername" placeholder="Enter your username" autocomplete="username" required>
                        </div>

                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password" required>
                        </div>

                        <button type="submit" style="width: 100%;">Login</button>
                    </form>

                    <div class="verification-badge" style="margin-top: 20px;">
                        üîí <strong>Secure Access:</strong> GPS and photo verification enabled for data integrity
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- App View -->
    <div id="appView" style="display: none;">
        <div class="container">
            <div class="user-info-bar">
                <div class="user-details">
                    <span id="userName"></span>
                    <span id="userTeam" class="team-badge" style="display: none;"></span>
                </div>
                <button onclick="logout()" class="btn-danger" style="background: rgba(229, 62, 62, 0.9);">Logout</button>
            </div>

            <div class="card">
                <div class="tab-container">
                    <button class="tab active" onclick="switchTab('collect')">üìù Collect Sample</button>
                    <button class="tab" onclick="switchTab('samples')">üìä View Samples</button>
                    <button class="tab" onclick="switchTab('dashboard')" id="dashboardTab" style="display: none;">üìà Dashboard</button>
                    <button class="tab" onclick="switchTab('settings')" id="settingsTab" style="display: none;">‚öôÔ∏è Settings</button>
                </div>

                <!-- Collect View -->
                <div id="collectView" class="view active">
                    <h2 style="color: var(--qu-primary);">New Sample Collection</h2>

                    <form id="sampleForm">
                        <div class="form-group">
                            <label>Sample ID</label>
                            <input type="text" id="sampleId" readonly style="background: var(--bg-light); font-weight: 600; color: var(--qu-primary);">
                        </div>

                        <div class="form-group">
                            <label>Animal Type *</label>
                            <select id="animalType" required>
                                <option value="">Select animal type</option>
                                <option value="Camel">Camel (ÿ•ÿ®ŸÑ)</option>
                                <option value="Sheep">Sheep (ÿ£ÿ∫ŸÜÿßŸÖ)</option>
                                <option value="Goat">Goat (ŸÖÿßÿπÿ≤)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Source Type *</label>
                            <select id="sourceType" required>
                                <option value="">Select source</option>
                                <option value="Farm">Farm (ŸÖÿ≤ÿ±ÿπÿ©)</option>
                                <option value="Free-ranging">Free-ranging (ÿ≥ÿßÿ¶ÿ®ÿ©)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Animal Age (years)</label>
                            <input type="number" id="animalAge" step="0.5" min="0" placeholder="e.g., 3.5">
                        </div>

                        <div class="form-group">
                            <label>Lactation Season (Number)</label>
                            <input type="number" id="lactationSeason" min="1" max="20" placeholder="1, 2, 3...">
                            <small style="color: var(--text-light); font-size: 13px;">Enter lactation number (1st, 2nd, 3rd, etc.)</small>
                        </div>

                        <div class="form-group">
                            <label>Health Status *</label>
                            <select id="healthStatus" required>
                                <option value="">Select health status</option>
                                <option value="Healthy">Healthy (ÿ≥ŸÑŸäŸÖ)</option>
                                <option value="Diseased">Diseased (ŸÖÿ±Ÿäÿ∂)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Collection Notes</label>
                            <textarea id="notes" placeholder="Any additional observations..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Sample Photos (3-5 photos recommended) *</label>
                            <p style="color: var(--text-light); font-size: 13px; margin-bottom: 10px;">
                                üì∏ Take 3-5 photos with camera for better verification (minimum 1, maximum 5)
                            </p>
                            <input type="file" id="photoInput" accept="image/*" capture="environment" multiple>
                            <button type="button" onclick="document.getElementById('photoInput').click()" class="camera-btn">
                                Take Photos
                            </button>
                            <div id="photoPreview" class="photo-grid"></div>
                        </div>

                        <div class="form-group">
                            <label>GPS Location *</label>
                            <p style="color: var(--text-light); font-size: 13px; margin-bottom: 10px;">
                                üìç GPS accuracy must be 100m or better. If no signal available, location will be saved when signal returns.
                            </p>
                            <button type="button" id="captureLocBtn" onclick="captureVerifiedLocation()" class="btn-secondary">
                                üìç Capture Current Location
                            </button>
                            <div id="locationInfo" style="display: none;" class="gps-verified"></div>
                        </div>

                        <div class="form-group">
                            <label>Collection Date & Time</label>
                            <input type="text" id="collectionDateTime" readonly style="background: var(--bg-light);">
                            <small style="color: var(--text-light); font-size: 13px;">Automatically recorded</small>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button type="button" onclick="saveDraft()" class="btn-secondary" style="flex: 1;">
                                üíæ Save Draft
                            </button>
                            <button type="button" onclick="submitSample()" class="btn-success" style="flex: 2; font-size: 18px;">
                                ‚úÖ Submit Sample
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Samples View -->
                <div id="samplesView" class="view">
                    <h2 style="color: var(--qu-primary);">Sample Records</h2>

                    <div style="display: flex; gap: 12px; margin: 20px 0; flex-wrap: wrap;">
                        <select id="filterAnimal" onchange="filterSamples()" style="flex: 1; min-width: 150px;">
                            <option value="">All Animals</option>
                            <option value="Camel">Camel</option>
                            <option value="Sheep">Sheep</option>
                            <option value="Goat">Goat</option>
                        </select>
                        <select id="filterTeam" onchange="filterSamples()" style="flex: 1; min-width: 150px; display: none;">
                            <option value="">All Teams</option>
                        </select>
                        <select id="filterStatus" onchange="filterSamples()" style="flex: 1; min-width: 150px;">
                            <option value="">All Status</option>
                            <option value="pending">Pending (Draft)</option>
                            <option value="submitted">Submitted</option>
                        </select>
                        <button onclick="exportToExcel()" class="btn-secondary">üì• Export to Excel</button>
                    </div>

                    <div id="samplesContainer" class="sample-grid"></div>
                </div>

                <!-- Dashboard View -->
                <div id="dashboardView" class="view">
                    <h2 style="color: var(--qu-primary);">Dashboard & Analytics</h2>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalSamples">0</div>
                            <div class="stat-label">Total Samples</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);">
                            <div class="stat-number" id="totalCamels">0</div>
                            <div class="stat-label">Camel Samples</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #4A5568 0%, #718096 100%);">
                            <div class="stat-number" id="totalSheep">0</div>
                            <div class="stat-label">Sheep Samples</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #744210 0%, #9C6644 100%);">
                            <div class="stat-number" id="totalGoats">0</div>
                            <div class="stat-label">Goat Samples</div>
                        </div>
                    </div>

                    <div style="margin-top: 40px;">
                        <h3 style="color: var(--qu-primary); margin-bottom: 15px;">Team Progress</h3>
                        <div id="teamProgress"></div>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="settingsView" class="view">
                    <h2 style="color: var(--qu-primary);">Admin Settings</h2>

                    <div class="alert alert-warning">
                        ‚ö†Ô∏è <strong>Admin Access Only:</strong> These settings control the entire system
                    </div>

                    <!-- Backup Section -->
                    <h3 style="margin-top: 30px; color: var(--qu-primary);">üíæ Data Backup & Cloud Sync</h3>
                    <div class="card" style="margin-bottom: 20px;">
                        <p style="color: var(--text-light); margin-bottom: 15px;">
                            <strong>Cloud Storage:</strong> <a href="https://quedusa.sharepoint.com/:f:/s/AlUlaproject/IgDYTagisFsrQrnCClX7tY2XAW0-6dDprDYBkUBIUOD5HdY?e=BM6OQz" target="_blank" style="color: var(--qu-primary); text-decoration: none; padding: 8px 16px; background: #E6F7FF; border-radius: 5px; display: inline-block;">üìÅ Open SharePoint Folder ‚Üí</a>
                        </p>
                        <div id="backupIndicator" style="display: none; margin-bottom: 15px; padding: 10px; background: #E6F7FF; border-left: 4px solid var(--qu-primary); color: var(--text-dark);"></div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <button onclick="downloadBackup()" class="btn-secondary" style="width: 100%;">
                                üì• Download Backup File
                            </button>
                            <button onclick="restoreFromBackup()" class="btn-secondary" style="width: 100%;">
                                üì§ Restore from Backup
                            </button>
                            <button onclick="exportToExcel()" class="btn-secondary" style="width: 100%;">
                                üìä Export Excel
                            </button>
                        </div>
                        <p style="margin-top: 15px; font-size: 13px; color: var(--text-light);">
                            üí° <strong>Tip:</strong> Download backup files and upload them to your SharePoint folder for cloud storage.
                        </p>
                    </div>

                    <h3 style="margin-top: 30px; color: var(--qu-primary);">üë• Manage Students & Teams</h3>
                    <div id="studentsList"></div>

                    <h3 style="margin-top: 30px; color: var(--qu-primary);">‚ûï Add New Student</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <input type="text" id="newStudentName" placeholder="Student name">
                        <input type="text" id="newStudentUsername" placeholder="Username">
                        <input type="password" id="newStudentPassword" placeholder="Password (6 digits)">
                        <select id="newStudentTeam">
                            <option value="">Select Team</option>
                            <option value="Team A">Team A</option>
                            <option value="Team B">Team B</option>
                            <option value="Team C">Team C</option>
                            <option value="Team D">Team D</option>
                        </select>
                    </div>
                    <button onclick="addStudent()" class="btn-secondary" style="margin-top: 15px;">Add Student</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="submitModal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--qu-primary); margin-bottom: 15px;">‚ö†Ô∏è Confirm Submission</h3>
            <p style="margin-bottom: 20px;">Are you sure you want to submit this sample?</p>
            <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">
                <strong>Once submitted, you cannot edit or delete this sample.</strong><br>
                You can only update it after admin review.
            </p>
            <div class="modal-buttons">
                <button onclick="closeSubmitModal()" class="btn-secondary">Cancel</button>
                <button onclick="confirmSubmit()" class="btn-success">Yes, Submit</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p><strong>Raw Milk Project</strong> | One Health Laboratory</p>
        <p>Department of Preventive Veterinary Medicine</p>
        <p>College of Veterinary Medicine, Qassim University</p>
        <p style="margin-top: 10px; font-size: 12px;">¬© 2026 All Rights Reserved</p>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let samples = [];
        let users = [];
        let currentLocation = null;
        let locationCaptureTime = null;
        let capturedPhotos = [];
        let sampleIdCounter = 0;
        let currentDraft = null;

        // Initialize
        function initializeApp() {
            users = JSON.parse(localStorage.getItem('users')) || [
                {
                    id: 1,
                    name: 'Dr. Sulaiman Aljasir',
                    username: 'sulaiman',
                    password: '220150',
                    role: 'admin',
                    permissions: ['all'],
                    team: null
                },
                {
                    id: 2,
                    name: 'Ibrahim',
                    username: 'ibrahim',
                    password: '330160',
                    role: 'admin',
                    permissions: ['view_data', 'export_data', 'view_dashboard'],
                    team: null
                },
                {
                    id: 3,
                    name: 'Imran',
                    username: 'imran',
                    password: '440170',
                    role: 'admin',
                    permissions: ['view_data', 'export_data', 'view_dashboard'],
                    team: null
                }
            ];

            // Load samples from localStorage
            samples = JSON.parse(localStorage.getItem('samples')) || [];

            // Initialize sample counter from existing samples
            sampleIdCounter = parseInt(localStorage.getItem('sampleIdCounter')) || 0;

            // Generate initial sample ID
            generateSampleId();
            updateCollectionDateTime();

            // Photo input handler
            document.getElementById('photoInput').addEventListener('change', handlePhotoCapture);
        }

        // Login with username
        function login() {
            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.username.toLowerCase() === username && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showAlert('‚úÖ Login successful!', 'success', 'loginAlert');
                setTimeout(() => {
                    document.getElementById('loginView').style.display = 'none';
                    document.getElementById('appView').style.display = 'block';
                    showApp();
                }, 800);
            } else {
                showAlert('‚ùå Invalid username or password', 'error', 'loginAlert');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            location.reload();
        }

        function showApp() {
            document.getElementById('userName').textContent = currentUser.name;

            if (currentUser.team) {
                document.getElementById('userTeam').textContent = currentUser.team;
                document.getElementById('userTeam').style.display = 'inline-block';
            }

            if (currentUser.role === 'admin') {
                document.getElementById('dashboardTab').style.display = 'block';
                if (currentUser.permissions.includes('all')) {
                    document.getElementById('settingsTab').style.display = 'block';
                }
                document.getElementById('filterTeam').style.display = 'block';
                populateTeamFilter();
            }

            renderSamples();
            updateDashboard();
            loadStudentsList();
        }

        // VERIFIED GPS CAPTURE - 100m accuracy, offline support
        function captureVerifiedLocation() {
            if (!navigator.geolocation) {
                alert('‚ùå GPS not supported by your device');
                return;
            }

            const btn = document.getElementById('captureLocBtn');
            btn.disabled = true;
            btn.textContent = 'üìç Getting location...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const accuracy = position.coords.accuracy;

                    // Allow up to 100m accuracy (was 50m)
                    if (accuracy > 100) {
                        const proceed = confirm(`‚ö†Ô∏è GPS accuracy is ${accuracy.toFixed(0)}m (>100m).\n\nWeak signal detected. Do you want to:\n- YES: Save sample without GPS (will update when signal improves)\n- NO: Wait for better signal`);

                        if (proceed) {
                            // Save with null location, mark as pending GPS
                            currentLocation = {
                                latitude: null,
                                longitude: null,
                                accuracy: null,
                                timestamp: new Date().toISOString(),
                                verified: false,
                                pendingGPS: true
                            };

                            locationCaptureTime = Date.now();

                            document.getElementById('locationInfo').style.display = 'block';
                            document.getElementById('locationInfo').innerHTML = `
                                ‚ö†Ô∏è GPS pending (weak signal)<br>
                                Sample can be submitted without GPS.<br>
                                Location will update automatically when signal improves.
                            `;
                            document.getElementById('locationInfo').style.background = '#feebc8';
                            document.getElementById('locationInfo').style.color = '#744210';

                            btn.disabled = false;
                            btn.textContent = '‚ö†Ô∏è GPS Pending (Weak Signal)';
                            btn.style.background = '#dd6b20';
                        } else {
                            btn.disabled = false;
                            btn.textContent = 'üìç Capture Current Location';
                        }
                        return;
                    }

                    // Good GPS signal
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: accuracy,
                        timestamp: new Date().toISOString(),
                        verified: true,
                        pendingGPS: false
                    };

                    locationCaptureTime = Date.now();

                    document.getElementById('locationInfo').style.display = 'block';
                    document.getElementById('locationInfo').style.background = '#c6f6d5';
                    document.getElementById('locationInfo').style.color = '#22543d';
                    document.getElementById('locationInfo').innerHTML = `
                        ‚úì Location verified<br>
                        Lat: ${currentLocation.latitude.toFixed(6)}<br>
                        Lng: ${currentLocation.longitude.toFixed(6)}<br>
                        Accuracy: ¬±${accuracy.toFixed(0)}m
                    `;

                    btn.disabled = false;
                    btn.textContent = '‚úì Location Captured';
                    btn.style.background = '#38a169';
                },
                (error) => {
                    const proceed = confirm(`‚ùå GPS Error: ${error.message}\n\nNo GPS signal available. Do you want to:\n- YES: Save sample without GPS (will update when signal available)\n- NO: Try again later`);

                    if (proceed) {
                        currentLocation = {
                            latitude: null,
                            longitude: null,
                            accuracy: null,
                            timestamp: new Date().toISOString(),
                            verified: false,
                            pendingGPS: true
                        };

                        locationCaptureTime = Date.now();

                        document.getElementById('locationInfo').style.display = 'block';
                        document.getElementById('locationInfo').style.background = '#feebc8';
                        document.getElementById('locationInfo').style.color = '#744210';
                        document.getElementById('locationInfo').innerHTML = `
                            ‚ö†Ô∏è No GPS signal<br>
                            Sample accepted without location.<br>
                            Will update automatically when signal returns.
                        `;

                        btn.disabled = false;
                        btn.textContent = '‚ö†Ô∏è No GPS Signal';
                        btn.style.background = '#dd6b20';
                    } else {
                        btn.disabled = false;
                        btn.textContent = 'üìç Capture Current Location';
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        // VERIFIED PHOTO CAPTURE - 1 to 5 photos
        function handlePhotoCapture(event) {
            const files = Array.from(event.target.files);

            // Limit to 5 photos
            if (files.length > 5) {
                alert('‚ö†Ô∏è Maximum 5 photos allowed. Only first 5 will be used.');
                files.splice(5);
            }

            capturedPhotos = [];

            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    capturedPhotos.push({
                        data: e.target.result,
                        timestamp: new Date().toISOString(),
                        verified: true
                    });

                    const div = document.createElement('div');
                    div.className = 'photo-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Photo ${index + 1}">
                        <button class="remove-photo" onclick="removePhoto(${index})" type="button">√ó</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removePhoto(index) {
            capturedPhotos.splice(index, 1);
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            capturedPhotos.forEach((photo, i) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `
                    <img src="${photo.data}" alt="Photo ${i + 1}">
                    <button class="remove-photo" onclick="removePhoto(${i})" type="button">√ó</button>
                `;
                preview.appendChild(div);
            });
        }

        // Generate UNIQUE Sample ID - Sequential numbering
        function generateSampleId() {
            // Find the highest sample number from existing samples
            let maxNumber = 0;
            samples.forEach(sample => {
                const match = sample.sampleId.match(/RM-(\d+)/);
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxNumber) {
                        maxNumber = num;
                    }
                }
            });

            // Next number is max + 1
            sampleIdCounter = maxNumber + 1;
            document.getElementById('sampleId').value = `RM-${sampleIdCounter}`;

            // Save counter
            localStorage.setItem('sampleIdCounter', sampleIdCounter.toString());
            updateCollectionDateTime();
        }

        function updateCollectionDateTime() {
            const now = new Date();
            document.getElementById('collectionDateTime').value = now.toLocaleString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Save as Draft (no GPS/photo required)
        function saveDraft() {
            const sampleId = document.getElementById('sampleId').value;
            const animalType = document.getElementById('animalType').value;
            const sourceType = document.getElementById('sourceType').value;

            if (!animalType || !sourceType) {
                alert('‚ùå Please select at least Animal Type and Source Type to save draft');
                return;
            }

            const now = new Date();
            const draft = {
                id: currentDraft ? currentDraft.id : Date.now(),
                sampleId: sampleId,
                animalType: animalType,
                sourceType: sourceType,
                animalAge: document.getElementById('animalAge').value,
                lactationSeason: document.getElementById('lactationSeason').value,
                healthStatus: document.getElementById('healthStatus').value,
                notes: document.getElementById('notes').value,
                photos: capturedPhotos,
                location: currentLocation,
                collectedBy: currentUser.name,
                collectedById: currentUser.id,
                team: currentUser.team,
                timestamp: now.toISOString(),
                collectionDateTime: now.toLocaleString(),
                status: 'pending',
                verified: false,
                version: "2.0"
            };

            // Update or add
            const existingIndex = samples.findIndex(s => s.id === draft.id);
            if (existingIndex >= 0) {
                samples[existingIndex] = draft;
            } else {
                samples.push(draft);
            }

            // Save to localStorage
            localStorage.setItem('samples', JSON.stringify(samples));
            autoBackup();

            alert('‚úÖ Draft saved! You can submit it later.');

            // Reset form but keep the same sample ID for editing
            currentDraft = draft;
        }

        // Submit Sample with Confirmation
        function submitSample() {
            // Validate required fields
            const animalType = document.getElementById('animalType').value;
            const sourceType = document.getElementById('sourceType').value;
            const healthStatus = document.getElementById('healthStatus').value;

            if (!animalType || !sourceType || !healthStatus) {
                alert('‚ùå Please fill all required fields (marked with *)');
                return;
            }

            // Verify GPS (allow pending GPS)
            if (!currentLocation) {
                alert('‚ùå Please capture GPS location first (or accept weak signal option)');
                return;
            }

            // Verify Photos (minimum 1)
            if (capturedPhotos.length === 0) {
                alert('‚ùå Please take at least 1 photo (3-5 recommended)');
                return;
            }

            // Show confirmation modal
            document.getElementById('submitModal').classList.add('active');
        }

        function closeSubmitModal() {
            document.getElementById('submitModal').classList.remove('active');
        }

        function confirmSubmit() {
            const now = new Date();
            const sample = {
                id: currentDraft ? currentDraft.id : Date.now(),
                sampleId: document.getElementById('sampleId').value,
                animalType: document.getElementById('animalType').value,
                sourceType: document.getElementById('sourceType').value,
                animalAge: document.getElementById('animalAge').value,
                lactationSeason: document.getElementById('lactationSeason').value,
                healthStatus: document.getElementById('healthStatus').value,
                notes: document.getElementById('notes').value,
                photos: capturedPhotos,
                location: currentLocation,
                collectedBy: currentUser.name,
                collectedById: currentUser.id,
                team: currentUser.team,
                timestamp: now.toISOString(),
                collectionDateTime: now.toLocaleString(),
                status: 'submitted',
                verified: currentLocation.verified,
                version: "2.0"
            };

            // Update or add
            const existingIndex = samples.findIndex(s => s.id === sample.id);
            if (existingIndex >= 0) {
                samples[existingIndex] = sample;
            } else {
                samples.push(sample);
            }

            // Save to localStorage
            localStorage.setItem('samples', JSON.stringify(samples));

            // Increment counter for next sample
            sampleIdCounter++;
            localStorage.setItem('sampleIdCounter', sampleIdCounter.toString());

            // Auto-backup
            autoBackup();

            closeSubmitModal();
            alert('‚úÖ Sample submitted successfully!');

            // Reset form completely
            document.getElementById('sampleForm').reset();
            generateSampleId();
            currentLocation = null;
            locationCaptureTime = null;
            capturedPhotos = [];
            currentDraft = null;
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('locationInfo').style.display = 'none';

            // Reset location button
            const btn = document.getElementById('captureLocBtn');
            btn.textContent = 'üìç Capture Current Location';
            btn.style.background = '';
        }

        // Automatic Backup Functions
        function autoBackup() {
            const lastBackup = new Date().toISOString();
            localStorage.setItem('lastBackup', lastBackup);
            updateBackupIndicator();
        }

        function updateBackupIndicator() {
            const lastBackup = localStorage.getItem('lastBackup');
            if (lastBackup) {
                const date = new Date(lastBackup);
                const timeAgo = getTimeAgo(date);
                const indicator = document.getElementById('backupIndicator');
                if (indicator) {
                    indicator.textContent = `üíæ Last backup: ${timeAgo}`;
                    indicator.style.display = 'block';
                }
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            const days = Math.floor(hours / 24);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        function downloadBackup() {
            const backupData = {
                samples: samples,
                users: users.map(u => ({...u, password: '***'})),
                exportDate: new Date().toISOString(),
                version: '2.0',
                sampleCounter: sampleIdCounter,
                projectInfo: {
                    name: 'Raw Milk Project',
                    institution: 'Qassim University',
                    department: 'Department of Preventive Veterinary Medicine'
                }
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            const time = new Date().toISOString().split('T')[1].split('.')[0].replace(/:/g, '-');
            a.href = url;
            a.download = `raw-milk-backup-${date}-${time}.json`;
            a.click();

            alert('‚úÖ Backup file downloaded! Upload this to your SharePoint folder.');
        }

        function restoreFromBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const backup = JSON.parse(event.target.result);

                        if (confirm(`Restore ${backup.samples.length} samples from backup dated ${new Date(backup.exportDate).toLocaleString()}?\n\nWarning: This will replace current data!`)) {
                            samples = backup.samples || [];
                            sampleIdCounter = backup.sampleCounter || samples.length;

                            localStorage.setItem('samples', JSON.stringify(samples));
                            localStorage.setItem('sampleIdCounter', sampleIdCounter.toString());

                            alert('‚úÖ Backup restored successfully!');
                            renderSamples();
                            updateDashboard();
                            generateSampleId();
                        }
                    } catch (error) {
                        alert('‚ùå Invalid backup file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Render Samples with Team Info
        function renderSamples() {
            const container = document.getElementById('samplesContainer');
            let filteredSamples = [...samples];

            // Filter by role
            if (currentUser.role === 'student') {
                filteredSamples = filteredSamples.filter(s => s.team === currentUser.team);
            }

            // Filter by animal type
            const animalFilter = document.getElementById('filterAnimal').value;
            if (animalFilter) {
                filteredSamples = filteredSamples.filter(s => s.animalType === animalFilter);
            }

            // Filter by team
            const teamFilter = document.getElementById('filterTeam').value;
            if (teamFilter) {
                filteredSamples = filteredSamples.filter(s => s.team === teamFilter);
            }

            // Filter by status
            const statusFilter = document.getElementById('filterStatus').value;
            if (statusFilter) {
                filteredSamples = filteredSamples.filter(s => s.status === statusFilter);
            }

            // Sort by sample ID (descending - newest first)
            filteredSamples.sort((a, b) => {
                const aNum = parseInt(a.sampleId.replace('RM-', ''));
                const bNum = parseInt(b.sampleId.replace('RM-', ''));
                return bNum - aNum;
            });

            if (filteredSamples.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">No samples found</p>';
                return;
            }

            container.innerHTML = filteredSamples.map(sample => `
                <div class="sample-card">
                    ${sample.photos && sample.photos[0] ?
                        `<img src="${sample.photos[0].data || sample.photos[0]}" alt="Sample" class="sample-photo">` :
                        '<div class="sample-photo" style="display: flex; align-items: center; justify-content: center; color: var(--text-light);">No Photo</div>'
                    }
                    <div class="sample-content">
                        <div class="sample-id">${sample.sampleId}</div>
                        <div class="sample-info">
                            <strong>Status:</strong>
                            <span class="status-badge status-${sample.status || 'pending'}">${sample.status === 'submitted' ? 'Submitted' : 'Draft'}</span>
                        </div>
                        <div class="sample-info">
                            <strong>Animal:</strong>
                            <span>${sample.animalType}</span>
                        </div>
                        <div class="sample-info">
                            <strong>Source:</strong>
                            <span>${sample.sourceType}</span>
                        </div>
                        <div class="sample-info">
                            <strong>Health:</strong>
                            <span class="status-badge status-${sample.healthStatus.toLowerCase()}">${sample.healthStatus}</span>
                        </div>
                        <div class="sample-info">
                            <strong>Team:</strong>
                            <span>${sample.team || 'N/A'}</span>
                        </div>
                        <div class="sample-info">
                            <strong>Collected by:</strong>
                            <span>${sample.collectedBy}</span>
                        </div>
                        <div class="sample-info">
                            <strong>Date:</strong>
                            <span>${sample.collectionDateTime || new Date(sample.timestamp).toLocaleDateString()}</span>
                        </div>
                        ${sample.location && sample.location.latitude ? `
                            <div class="sample-info">
                                <strong>GPS:</strong>
                                <span>${sample.location.latitude.toFixed(4)}, ${sample.location.longitude.toFixed(4)}</span>
                            </div>
                        ` : sample.location && sample.location.pendingGPS ? `
                            <div class="sample-info">
                                <strong>GPS:</strong>
                                <span style="color: #dd6b20;">‚ö†Ô∏è Pending (Weak Signal)</span>
                            </div>
                        ` : ''}
                        ${sample.photos ? `
                            <div class="sample-info">
                                <strong>Photos:</strong>
                                <span>${sample.photos.length} photo(s)</span>
                            </div>
                        ` : ''}
                        ${sample.verified ? '<div class="gps-verified" style="margin-top: 10px; font-size: 11px;">‚úì Verified Sample</div>' : ''}
                    </div>
                </div>
            `).join('');
        }

        function filterSamples() {
            renderSamples();
        }

        // Dashboard
        function updateDashboard() {
            const submittedSamples = samples.filter(s => s.status === 'submitted');

            document.getElementById('totalSamples').textContent = submittedSamples.length;
            document.getElementById('totalCamels').textContent = submittedSamples.filter(s => s.animalType === 'Camel').length;
            document.getElementById('totalSheep').textContent = submittedSamples.filter(s => s.animalType === 'Sheep').length;
            document.getElementById('totalGoats').textContent = submittedSamples.filter(s => s.animalType === 'Goat').length;

            // Team progress
            const teamProgress = document.getElementById('teamProgress');
            const teams = ['Team A', 'Team B', 'Team C', 'Team D'];
            const teamData = teams.map(team => {
                const teamSamples = submittedSamples.filter(s => s.team === team);
                return { team, count: teamSamples.length };
            });

            teamProgress.innerHTML = teamData.map(data => `
                <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <strong>${data.team}</strong>
                    <span style="font-size: 20px; color: var(--qu-primary);">${data.count} samples</span>
                </div>
            `).join('');
        }

        // Export
        function exportToExcel() {
            let exportSamples = samples.filter(s => s.status === 'submitted');

            if (currentUser.role === 'student') {
                exportSamples = exportSamples.filter(s => s.team === currentUser.team);
            }

            let csv = 'Sample ID,Animal Type,Source,Age,Lactation Season,Health Status,Notes,Collected By,Team,Date/Time,Latitude,Longitude,GPS Status,Photos Count,Status\n';

            exportSamples.forEach(sample => {
                csv += `"${sample.sampleId}","${sample.animalType}","${sample.sourceType}",`;
                csv += `"${sample.animalAge}","${sample.lactationSeason || ''}","${sample.healthStatus}",`;
                csv += `"${sample.notes}","${sample.collectedBy}","${sample.team || ''}",`;
                csv += `"${sample.collectionDateTime || new Date(sample.timestamp).toLocaleString()}",`;
                csv += `"${sample.location && sample.location.latitude ? sample.location.latitude : 'N/A'}",`;
                csv += `"${sample.location && sample.location.longitude ? sample.location.longitude : 'N/A'}",`;
                csv += `"${sample.verified ? 'Verified' : sample.location && sample.location.pendingGPS ? 'Pending' : 'N/A'}",`;
                csv += `"${sample.photos ? sample.photos.length : 0}",`;
                csv += `"${sample.status || 'pending'}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `raw-milk-samples-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();

            alert(`‚úÖ Exported ${exportSamples.length} submitted samples to Excel`);
        }

        // Tab Navigation
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'View').classList.add('active');

            if (tabName === 'samples') renderSamples();
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'settings') loadStudentsList();
        }

        // Alerts
        function showAlert(message, type, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }

        // Language Toggle
        let currentLang = 'en';

        const translations = {
            en: {
                langToggle: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
                projectTitle: 'Raw Milk Project',
                departmentInfo: 'One Health Laboratory'
            },
            ar: {
                langToggle: 'English',
                projectTitle: 'ŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ≠ŸÑŸäÿ® ÿßŸÑÿÆÿßŸÖ',
                departmentInfo: 'ŸÖÿÆÿ™ÿ®ÿ± ÿßŸÑÿµÿ≠ÿ© ÿßŸÑŸàÿßÿ≠ÿØÿ©'
            }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            updateLanguage();
        }

        function updateLanguage() {
            const t = translations[currentLang];
            const isArabic = currentLang === 'ar';

            document.documentElement.setAttribute('lang', currentLang);
            document.documentElement.setAttribute('dir', isArabic ? 'rtl' : 'ltr');

            const langToggleEl = document.getElementById('langToggle');
            if (langToggleEl) langToggleEl.textContent = t.langToggle;

            const projectTitle = document.querySelector('.project-title');
            const deptInfo = document.querySelector('.department-info');
            if (projectTitle) projectTitle.textContent = t.projectTitle;
            if (deptInfo) deptInfo.textContent = t.departmentInfo;

            if (isArabic) {
                document.body.style.textAlign = 'right';
            } else {
                document.body.style.textAlign = 'left';
            }
        }

        // Student Management
        function populateTeamFilter() {
            const filterTeam = document.getElementById('filterTeam');
            const teams = [...new Set(users.filter(u => u.team).map(u => u.team))];

            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                filterTeam.appendChild(option);
            });
        }

        function loadStudentsList() {
            const container = document.getElementById('studentsList');
            const students = users.filter(u => u.role === 'student');

            if (students.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); padding: 15px;">No students added yet</p>';
                return;
            }

            container.innerHTML = students.map(student => `
                <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${student.name}</strong><br>
                        <span style="color: var(--text-light); font-size: 13px;">@${student.username} | ${student.team || 'No team'}</span>
                    </div>
                    <button onclick="removeStudent(${student.id})" class="btn-danger" style="padding: 8px 16px; font-size: 14px;">Remove</button>
                </div>
            `).join('');
        }

        function addStudent() {
            if (!currentUser.permissions.includes('all')) {
                alert('‚ùå Insufficient permissions');
                return;
            }

            const name = document.getElementById('newStudentName').value.trim();
            const username = document.getElementById('newStudentUsername').value.trim();
            const password = document.getElementById('newStudentPassword').value;
            const team = document.getElementById('newStudentTeam').value;

            if (!name || !username || !password || !team) {
                alert('‚ùå Please fill all fields including team selection');
                return;
            }

            // Check if username already exists
            if (users.find(u => u.username.toLowerCase() === username.toLowerCase())) {
                alert('‚ùå Username already exists. Please choose a different username.');
                return;
            }

            users.push({
                id: Date.now(),
                name,
                username: username.toLowerCase(),
                password,
                role: 'student',
                team: team,
                permissions: ['collect_samples', 'view_own_samples']
            });

            localStorage.setItem('users', JSON.stringify(users));
            alert(`‚úÖ Student ${name} added to ${team}!`);

            document.getElementById('newStudentName').value = '';
            document.getElementById('newStudentUsername').value = '';
            document.getElementById('newStudentPassword').value = '';
            document.getElementById('newStudentTeam').value = '';

            loadStudentsList();
            populateTeamFilter();
        }

        function removeStudent(id) {
            if (!confirm('Are you sure you want to remove this student?')) return;

            users = users.filter(u => u.id !== id);
            localStorage.setItem('users', JSON.stringify(users));
            alert('‚úÖ Student removed');
            loadStudentsList();
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initializeApp();
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('loginView').style.display = 'none';
                document.getElementById('appView').style.display = 'block';
                showApp();
            }

            updateBackupIndicator();
            setInterval(updateBackupIndicator, 60000);
        });
    </script>
</body>
</html>
